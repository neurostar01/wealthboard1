<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WealthBoard â€” ìì‚°ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--b9:#0d1b3e;--b6:#1d4ed8;--b5:#3b82f6;--b4:#60a5fa;--b3:#93c5fd;--b0:#eff6ff;--g0:#f8fafc;--g1:#f1f5f9;--g2:#e2e8f0;--g4:#94a3b8;--g6:#475569;--g8:#1e293b;--gn:#ef4444;--rd:#1d4ed8;--og:#f59e0b;--pu:#8b5cf6;--sh:0 1px 3px rgba(13,27,62,.08);--shm:0 4px 16px rgba(13,27,62,.12);--shl:0 12px 40px rgba(13,27,62,.18);--r:16px;--rs:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',-apple-system,sans-serif;background:var(--g0);color:var(--g8);min-height:100vh}
.sidebar{position:fixed;left:0;top:0;width:240px;height:100vh;background:var(--b9);display:flex;flex-direction:column;z-index:100;box-shadow:4px 0 24px rgba(13,27,62,.18)}
.sidebar-logo{padding:28px 24px 22px;border-bottom:1px solid rgba(255,255,255,.08)}
.logo-mark{display:flex;align-items:center;gap:10px}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--b5),var(--b4));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.logo-text{font-size:17px;font-weight:700;color:#fff;letter-spacing:-.3px}
.logo-sub{font-size:11px;color:var(--b3);margin-top:2px}
.sidebar-nav{padding:16px 12px;flex:1}
.nav-label{font-size:10px;font-weight:600;color:var(--b4);letter-spacing:1.2px;text-transform:uppercase;padding:0 12px;margin:16px 0 6px}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:var(--rs);color:rgba(255,255,255,.6);font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;margin-bottom:2px}
.nav-item:hover{background:rgba(255,255,255,.06);color:#fff}
.nav-item.active{background:rgba(59,130,246,.2);color:#fff}
.nav-icon{font-size:16px;width:20px;text-align:center}
.sidebar-footer{padding:14px 12px;border-top:1px solid rgba(255,255,255,.08)}
.user-card{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--rs);background:rgba(255,255,255,.06)}
.user-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--b5),var(--pu));display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:600}
.user-name{font-size:13px;font-weight:600;color:#fff}
.user-plan{font-size:11px;color:var(--b3)}
.main{margin-left:240px;min-height:100vh}
.topbar{background:#fff;border-bottom:1px solid var(--g2);padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.page-title{font-size:20px;font-weight:700;letter-spacing:-.5px}
.page-sub{font-size:12px;color:var(--g4);margin-top:1px}
.topbar-right{display:flex;align-items:center;gap:10px}
.btn-icon{width:38px;height:38px;border-radius:10px;background:var(--g1);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:background .2s}
.btn-icon:hover{background:var(--g2)}
.btn-primary{background:var(--b6);color:#fff;border:none;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;transition:background .2s;font-family:inherit;display:flex;align-items:center;gap:6px}
.btn-primary:hover{background:#1e40af}
.date-badge{font-size:12px;color:var(--g4);background:var(--g1);padding:6px 12px;border-radius:8px;font-family:'DM Mono',monospace}
.api-bar{background:#fff;border-bottom:1px solid var(--g1);padding:7px 32px;display:flex;align-items:center;gap:18px;flex-wrap:wrap}
.api-label{font-size:10px;font-weight:600;color:var(--g4);letter-spacing:.8px;text-transform:uppercase}
.api-badge{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--g6)}
.api-dot{width:7px;height:7px;border-radius:50%;background:var(--g2);flex-shrink:0}
.api-dot.ok{background:var(--gn)}
.api-dot.loading{background:var(--og);animation:blink 1s infinite}
.api-dot.error{background:var(--rd)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.api-updated{margin-left:auto;font-size:11px;color:var(--g4);font-family:'DM Mono',monospace}
.content{padding:28px 32px}
.summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.summary-card{background:#fff;border-radius:var(--r);padding:22px;box-shadow:var(--sh);border:1px solid var(--g2);position:relative;overflow:hidden;transition:box-shadow .2s,transform .2s;animation:fadeUp .4s ease both}
.summary-card:hover{box-shadow:var(--shm);transform:translateY(-2px)}
.summary-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.summary-card.total::before{background:linear-gradient(90deg,var(--b6),var(--b4))}
.summary-card.domestic::before{background:linear-gradient(90deg,#10b981,#34d399)}
.summary-card.overseas::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.summary-card.crypto::before{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
.summary-card:nth-child(1){animation-delay:.05s}
.summary-card:nth-child(2){animation-delay:.10s}
.summary-card:nth-child(3){animation-delay:.15s}
.summary-card:nth-child(4){animation-delay:.20s}
.card-label{font-size:12px;font-weight:500;color:var(--g4);margin-bottom:10px}
.card-value{font-size:21px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:-.5px;margin-bottom:8px}
.card-change{font-size:12px;font-weight:600}
.card-change.up{color:#ef4444}
.card-change.down{color:#1d4ed8}
.card-icon{position:absolute;right:18px;top:18px;font-size:28px;opacity:.1}
.main-grid{display:grid;grid-template-columns:1fr 340px;gap:20px;margin-bottom:20px}
.card{background:#fff;border-radius:var(--r);box-shadow:var(--sh);border:1px solid var(--g2);overflow:hidden}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px 16px;border-bottom:1px solid var(--g1)}
.card-title{font-size:15px;font-weight:700}
.card-body{padding:20px 24px}
.chart-wrap{height:220px;position:relative}
.chart-tabs{display:flex;gap:4px}
.chart-tab{padding:5px 12px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--g4);transition:all .2s;font-family:inherit}
.chart-tab.active{background:var(--b0);color:var(--b6)}
.pie-wrap{height:180px;margin-bottom:16px}
.legend-list{display:flex;flex-direction:column;gap:8px}
.legend-item{display:flex;align-items:center;justify-content:space-between}
.legend-left{display:flex;align-items:center;gap:8px}
.legend-dot{width:10px;height:10px;border-radius:3px}
.legend-name{font-size:13px;color:var(--g6)}
.legend-pct{font-size:13px;font-weight:600;font-family:'DM Mono',monospace}
.portfolio-card{background:#fff;border-radius:var(--r);box-shadow:var(--sh);border:1px solid var(--g2);overflow:hidden;margin-bottom:20px}
.portfolio-table{width:100%;border-collapse:collapse}
.portfolio-table th{font-size:11px;font-weight:600;color:var(--g4);letter-spacing:.5px;text-align:left;padding:14px 20px 12px;text-transform:uppercase;background:var(--g0);border-bottom:1px solid var(--g2)}
.portfolio-table th:not(:first-child){text-align:right}
.portfolio-table td{padding:13px 20px;border-bottom:1px solid var(--g1);font-size:13px;vertical-align:middle}
.portfolio-table tbody tr:last-child td{border-bottom:none}
.portfolio-table td:not(:first-child){text-align:right}
.portfolio-table tbody tr{transition:background .15s}
.portfolio-table tbody tr:hover{background:var(--g0)}
.stock-info{display:flex;align-items:center;gap:10px}
.stock-badge{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;flex-shrink:0}
.stock-name{font-size:13px;font-weight:600}
.stock-ticker{font-size:11px;color:var(--g4);font-family:'DM Mono',monospace;margin-top:1px}
.badge-type{display:inline-block;padding:3px 9px;border-radius:6px;font-size:10px;font-weight:600}
.badge-kr{background:#dbeafe;color:var(--b6)}
.badge-us{background:#fef3c7;color:#d97706}
.badge-crypto{background:#ede9fe;color:#7c3aed}
.text-mono{font-family:'DM Mono',monospace;font-size:13px}
.text-up{color:var(--gn);font-weight:600}
.text-down{color:var(--rd);font-weight:600}
.row-actions{display:flex;justify-content:flex-end;gap:6px;opacity:0;transition:opacity .15s}
.portfolio-table tbody tr:hover .row-actions{opacity:1}
.btn-row{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .15s}
.btn-edit{background:var(--b0);color:var(--b6)}
.btn-edit:hover{background:#dbeafe}
.btn-del{background:#fee2e2;color:var(--rd)}
.btn-del:hover{background:#fecaca}
.price-loading{color:var(--og);font-size:11px}
.price-live{color:var(--gn);font-size:10px;margin-left:4px}
.empty-state{text-align:center;padding:48px 20px;color:var(--g4)}
.empty-icon{font-size:40px;margin-bottom:12px}
.empty-title{font-size:15px;font-weight:600;color:var(--g6);margin-bottom:6px}
.empty-sub{font-size:13px}
.bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.tx-item{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--g1)}
.tx-item:last-child{border-bottom:none}
.tx-left{display:flex;align-items:center;gap:12px}
.tx-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px}
.tx-icon.buy{background:#dbeafe}
.tx-icon.sell{background:#fee2e2}
.tx-icon.deposit{background:#d1fae5}
.tx-name{font-size:13px;font-weight:600}
.tx-date{font-size:11px;color:var(--g4);margin-top:1px}
.tx-price{font-size:13px;font-weight:700;font-family:'DM Mono',monospace;text-align:right}
.tx-qty{font-size:11px;color:var(--g4);margin-top:1px;text-align:right}
.tag{display:inline-block;padding:3px 9px;border-radius:6px;font-size:11px;font-weight:600}
.tag-up{background:#fee2e2;color:#dc2626}
.tag-down{background:#dbeafe;color:#1d4ed8}

/* â”€â”€ ì¢…ëª© ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(13,27,62,.45);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:#fff;border-radius:20px;width:520px;max-width:95vw;box-shadow:var(--shl);transform:translateY(20px) scale(.97);transition:transform .25s;overflow:hidden}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{padding:24px 28px 18px;border-bottom:1px solid var(--g1);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:17px;font-weight:700}
.modal-close{width:32px;height:32px;border-radius:8px;border:none;background:var(--g1);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:background .15s}
.modal-close:hover{background:var(--g2)}
.modal-body{padding:22px 28px}
.modal-footer{padding:14px 28px 22px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--g1)}
.form-group{margin-bottom:16px}
.form-label{font-size:12px;font-weight:600;color:var(--g6);letter-spacing:.3px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-input{width:100%;padding:10px 14px;border:1.5px solid var(--g2);border-radius:10px;font-size:14px;font-family:inherit;color:var(--g8);outline:none;transition:border-color .2s,box-shadow .2s}
.form-input:focus{border-color:var(--b5);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.form-input:disabled{background:var(--g0);color:var(--g4)}
.form-select{width:100%;padding:10px 14px;border:1.5px solid var(--g2);border-radius:10px;font-size:14px;font-family:inherit;color:var(--g8);outline:none;appearance:none;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%2394a3b8' d='M5 7L0 2h10z'/%3E%3C/svg%3E") no-repeat right 14px center;background-color:#fff;cursor:pointer;transition:border-color .2s}
.form-select:focus{border-color:var(--b5);outline:none}
.price-auto-row{display:flex;align-items:center;gap:8px}
.btn-fetch-price{padding:8px 14px;border-radius:8px;background:var(--b0);color:var(--b6);border:none;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;transition:background .15s;display:flex;align-items:center;gap:5px}
.btn-fetch-price:hover{background:#dbeafe}
.btn-fetch-price:disabled{opacity:.5;cursor:not-allowed}
.fetch-status{font-size:11px;color:var(--g4)}
.fetch-status.ok{color:var(--gn)}
.fetch-status.err{color:var(--rd)}
.color-swatches{display:flex;gap:7px;flex-wrap:wrap;margin-top:8px}
.swatch{width:28px;height:28px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .15s}
.swatch:hover{transform:scale(1.15)}
.swatch.selected{border-color:var(--g8);transform:scale(1.1)}
.btn-secondary{background:var(--g1);color:var(--g6);border:none;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:background .2s}
.btn-secondary:hover{background:var(--g2)}
.btn-danger{background:#fee2e2;color:var(--rd);border:none;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:background .2s}
.btn-danger:hover{background:#fecaca}
.hint-box{background:var(--g0);border:1px solid var(--g2);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--g6);line-height:1.6;margin-top:4px}
.hint-box strong{color:var(--g8)}

/* â”€â”€ ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (ëª¨ë‹¬ë³´ë‹¤ ë†’ì€ z-index) â”€â”€ */
.confirm-overlay{position:fixed;inset:0;background:rgba(13,27,62,.55);backdrop-filter:blur(6px);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.confirm-overlay.open{opacity:1;pointer-events:all}
.confirm-box{background:#fff;border-radius:18px;padding:32px 28px;width:340px;max-width:90vw;box-shadow:0 20px 60px rgba(13,27,62,.25);transform:scale(.95) translateY(8px);transition:transform .2s;text-align:center}
.confirm-overlay.open .confirm-box{transform:scale(1) translateY(0)}
.confirm-icon{font-size:38px;margin-bottom:14px}
.confirm-msg{font-size:16px;font-weight:700;color:var(--g8);margin-bottom:6px;line-height:1.4}
.confirm-sub{font-size:13px;color:var(--g4);margin-bottom:24px}
.confirm-btns{display:flex;gap:10px;justify-content:center}

/* Toast */
.toast{position:fixed;bottom:32px;right:32px;background:var(--g8);color:#fff;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:500;z-index:600;transform:translateY(20px);opacity:0;transition:all .3s;pointer-events:none;display:flex;align-items:center;gap:8px;box-shadow:var(--shl)}
.toast.show{transform:translateY(0);opacity:1}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}


/* ì‹œì¥ ì§€í‘œ ë°” */
.market-bar{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.market-item{background:#fff;border:1px solid var(--g2);border-radius:12px;padding:12px 16px;cursor:pointer;transition:all .2s;flex:1;min-width:110px;box-shadow:var(--sh)}
.market-item:hover{box-shadow:var(--shm);transform:translateY(-2px);border-color:var(--b5)}
.market-name{display:block;font-size:10px;font-weight:600;color:var(--g4);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px}
.market-price{display:block;font-size:14px;font-weight:700;font-family:'DM Mono',monospace;margin-bottom:2px}
.market-chg{font-size:11px;font-weight:600}
.market-chg.up{color:#ef4444}
.market-chg.down{color:#1d4ed8}

/* ì°¨íŠ¸ ëª¨ë‹¬ */
.chart-modal-overlay{position:fixed;inset:0;background:rgba(13,27,62,.5);backdrop-filter:blur(4px);z-index:400;display:flex;align-items:center;justify-content:center}
.chart-modal{background:#fff;border-radius:20px;width:720px;max-width:95vw;box-shadow:0 20px 60px rgba(13,27,62,.25);overflow:hidden}
.chart-modal-header{padding:20px 24px;border-bottom:1px solid var(--g1);display:flex;align-items:center;justify-content:space-between}

/* í•„í„° íƒ­ */
.filter-tabs{display:flex;gap:6px;padding:16px 24px 0;align-items:center}
.filter-tab{padding:6px 16px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid var(--g2);background:#fff;color:var(--g4);transition:all .15s;font-family:inherit}
.filter-tab.active{background:var(--b6);color:#fff;border-color:var(--b6)}
/* ë“œë˜ê·¸ */
.drag-handle{cursor:grab;color:var(--g2);font-size:16px;padding:0 6px;user-select:none;transition:color .15s}
.drag-handle:hover{color:var(--g4)}
tr.dragging{opacity:.4;background:var(--b0) !important}
tr.drag-over{border-top:2px solid var(--b5)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë°”ì¼ ë°˜ì‘í˜• (768px ì´í•˜)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  /* ì‚¬ì´ë“œë°” â†’ í•˜ë‹¨ íƒ­ë°”ë¡œ ì „í™˜ */
  .sidebar{
    top:auto;bottom:0;left:0;right:0;
    width:100%;height:60px;
    flex-direction:row;
    box-shadow:0 -2px 16px rgba(13,27,62,.18);
  }
  .sidebar-logo,.sidebar-footer{display:none}
  .sidebar-nav{
    padding:0;flex:1;
    display:flex;flex-direction:row;
    align-items:center;justify-content:space-around;
  }
  .nav-label{display:none}
  .nav-item{
    flex-direction:column;gap:3px;
    padding:8px 4px;font-size:10px;
    margin-bottom:0;border-radius:8px;
    min-width:52px;justify-content:center;align-items:center;
  }
  .nav-icon{font-size:20px;width:auto}

  /* ë©”ì¸ ì˜ì—­ */
  .main{margin-left:0;padding-bottom:70px}

  /* íƒ‘ë°” */
  .topbar{padding:0 16px;height:56px}
  .page-title{font-size:16px}
  .date-badge{display:none}

  /* api-bar */
  .api-bar{padding:6px 16px;gap:10px;overflow-x:auto;flex-wrap:nowrap;white-space:nowrap}
  .api-label{display:none}
  .api-updated{display:none}

  /* ì»¨í…ì¸  */
  .content{padding:16px}

  /* ìš”ì•½ ì¹´ë“œ: 2ì—´ */
  .summary-grid{grid-template-columns:repeat(2,1fr);gap:12px}
  .card-value{font-size:16px}
  .card-icon{font-size:20px}

  /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ: 1ì—´ */
  .main-grid{grid-template-columns:1fr;gap:12px}

  /* ë³´ìœ ì¢…ëª© í…Œì´ë¸” â†’ ì¹´ë“œí˜•ìœ¼ë¡œ */
  .portfolio-table thead{display:none}
  .portfolio-table tbody tr{
    display:block;
    padding:14px 16px;
    border-bottom:1px solid var(--g1);
    position:relative;
  }
  .portfolio-table tbody tr:hover{background:#fff}
  .portfolio-table td{
    display:inline-block;
    padding:2px 0;
    border:none;
    text-align:left !important;
    font-size:12px;
  }
  .portfolio-table td:first-child{display:block;margin-bottom:8px}
  .portfolio-table td:last-child{
    display:block;
    position:absolute;top:14px;right:12px;
  }
  /* í‰ê°€ê¸ˆì•¡/ìˆ˜ìµë¥  ë‚˜ë€íˆ */
  .portfolio-table td:nth-child(6),
  .portfolio-table td:nth-child(7){
    display:inline-block;
    margin-right:8px;
    font-size:13px;font-weight:600;
  }
  /* ìœ í˜•/í˜„ì¬ê°€/ìˆ˜ëŸ‰/ë§¤ìˆ˜ê°€ ì‘ê²Œ */
  .portfolio-table td:nth-child(2),
  .portfolio-table td:nth-child(3),
  .portfolio-table td:nth-child(4),
  .portfolio-table td:nth-child(5){
    font-size:11px;color:var(--g4);margin-right:6px;
  }
  .row-actions{opacity:1;gap:4px}
  .btn-row{padding:5px 10px;font-size:11px}

  /* í•˜ë‹¨ ê·¸ë¦¬ë“œ: 1ì—´ */
  .bottom-grid{grid-template-columns:1fr;gap:12px}

  /* ì¹´ë“œ íŒ¨ë”© ì¤„ì´ê¸° */
  .card-body{padding:14px 16px}
  .card-header{padding:14px 16px 12px}

  /* ëª¨ë‹¬ */
  .modal{width:100%;max-width:100%;border-radius:20px 20px 0 0;position:fixed;bottom:0;margin:0}
  .modal-overlay{align-items:flex-end}
  .form-row{grid-template-columns:1fr}

  /* ì½”ì¸ í…Œì´ë¸” */
  .portfolio-table th,
  .portfolio-table td{padding:10px 12px}
}

@media(max-width:400px){
  .summary-grid{grid-template-columns:1fr 1fr}
  .card-value{font-size:14px}
  .summary-card{padding:16px 14px}
}
</style>
</head>
<body>

<nav class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">
      <div class="logo-icon">ğŸ“ˆ</div>
      <div><div class="logo-text">WealthBoard</div><div class="logo-sub">ìì‚°ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</div></div>
    </div>
  </div>
  <div class="sidebar-nav" style="overflow-y:auto">
    <div class="nav-label">ë©”ì¸</div>
    <div class="nav-item active" id="nav-dashboard" onclick="navTo('dashboard')"><span class="nav-icon">ğŸ </span> ëŒ€ì‹œë³´ë“œ</div>
    <div class="nav-item" id="nav-portfolio" onclick="navTo('portfolio')"><span class="nav-icon">ğŸ’¼</span> í¬íŠ¸í´ë¦¬ì˜¤</div>
    <div class="nav-item" id="nav-analysis" onclick="navTo('analysis')"><span class="nav-icon">ğŸ“Š</span> ìˆ˜ìµ ë¶„ì„</div>
    <div class="nav-label">ë³´ìœ /ê´€ì‹¬</div>
    <div class="nav-item" id="nav-holdings" onclick="navTo('holdings')"><span class="nav-icon">ğŸ“‹</span> ë³´ìœ  ì¢…ëª©</div>
    <div class="nav-item" id="nav-watchlist" onclick="navTo('watchlist')"><span class="nav-icon">ğŸ‘€</span> ê´€ì‹¬ ì¢…ëª©</div>
    <div class="nav-label">ê´€ë¦¬</div>
    <div class="nav-item" id="nav-add" onclick="openModal()"><span class="nav-icon">â•</span> ì¢…ëª© ì¶”ê°€</div>
    <div class="nav-item" id="nav-tx" onclick="navTo('tx')"><span class="nav-icon">ğŸ”„</span> ê±°ë˜ ë‚´ì—­</div>
    <div class="nav-label">ë‰´ìŠ¤ & ì •ë³´</div>
    <div class="nav-item" onclick="window.open('https://finance.naver.com/news/mainnews.naver','_blank')"><span class="nav-icon">ğŸ“°</span> ë„¤ì´ë²„ ê¸ˆìœµë‰´ìŠ¤</div>
    <div class="nav-item" onclick="window.open('https://www.hankyung.com/economy','_blank')"><span class="nav-icon">ğŸ“ˆ</span> í•œêµ­ê²½ì œ</div>
    <div class="nav-item" onclick="window.open('https://www.mk.co.kr/economy/finance','_blank')"><span class="nav-icon">ğŸ’¹</span> ë§¤ì¼ê²½ì œ</div>
    <div class="nav-item" onclick="window.open('https://investing.com/news/stock-market-news','_blank')"><span class="nav-icon">ğŸŒ</span> Investing.com</div>
    <div class="nav-item" onclick="window.open('https://finance.yahoo.com/news','_blank')"><span class="nav-icon">ğŸ‡ºğŸ‡¸</span> Yahoo Finance</div>
  </div>
  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar">ê¹€</div>
      <div><div class="user-name">ê¹€íˆ¬ì</div><div class="user-plan" id="user-mode">ì—°ê²° ì¤‘...</div></div>
    </div>
  </div>
</nav>

<div class="main">
  <header class="topbar">
    <div>
      <div class="page-title">ëŒ€ì‹œë³´ë“œ</div>
      <div class="page-sub">í¬íŠ¸í´ë¦¬ì˜¤ ì¢…í•© í˜„í™©</div>
    </div>
    <div class="topbar-right">
      <div class="date-badge" id="current-date">â€”</div>
      <button class="btn-icon" onclick="fetchLive()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
      <button class="btn-primary" onclick="openModal()" style="white-space:nowrap">ï¼‹ ì¶”ê°€</button>
    </div>
  </header>

  <div class="api-bar">
    <span class="api-label">ë°ì´í„° ì—°ë™</span>
    <div class="api-badge"><div class="api-dot loading" id="dot-gist"></div> <span id="lbl-gist">Gist ì—°ê²° ì¤‘...</span></div>
    <div class="api-badge"><div class="api-dot loading" id="dot-crypto"></div> ì•”í˜¸í™”í (CoinGecko)</div>
    <div class="api-badge"><div class="api-dot loading" id="dot-kr"></div> êµ­ë‚´ì£¼ì‹ (Yahoo Finance)</div>
    <div class="api-badge"><div class="api-dot loading" id="dot-us"></div> í•´ì™¸ì£¼ì‹ (StockPrices)</div>
    <div class="api-badge"><div class="api-dot loading" id="dot-fx"></div> í™˜ìœ¨ (ì‹¤ì‹œê°„)</div>
    <span class="api-updated" id="api-updated">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
  </div>

  <div class="content">
    <div id="section-dashboard"></div>
    <!-- ì‹œì¥ ì§€í‘œ ë°” -->
    <div class="market-bar" id="market-bar">
      <div class="market-item" onclick="showMarketChart('KS11','KOSPI','#ef4444')">
        <span class="market-name">KOSPI</span>
        <span class="market-price" id="mkt-KS11">â€”</span>
        <span class="market-chg" id="mkt-KS11-c">â€”</span>
      </div>
      <div class="market-item" onclick="showMarketChart('IXIC','NASDAQ','#3b82f6')">
        <span class="market-name">NASDAQ</span>
        <span class="market-price" id="mkt-IXIC">â€”</span>
        <span class="market-chg" id="mkt-IXIC-c">â€”</span>
      </div>
      <div class="market-item" onclick="showMarketChart('DJI','ë‹¤ìš°ì¡´ìŠ¤','#8b5cf6')">
        <span class="market-name">DOW</span>
        <span class="market-price" id="mkt-DJI">â€”</span>
        <span class="market-chg" id="mkt-DJI-c">â€”</span>
      </div>
      <div class="market-item" onclick="showMarketChart('S%26P500','S&amp;P500','#f59e0b')">
        <span class="market-name">S&amp;P500</span>
        <span class="market-price" id="mkt-SP500">â€”</span>
        <span class="market-chg" id="mkt-SP500-c">â€”</span>
      </div>
      <div class="market-item" onclick="showMarketChart('USDKRW','ì›/ë‹¬ëŸ¬ í™˜ìœ¨','#10b981')">
        <span class="market-name">USD/KRW</span>
        <span class="market-price" id="mkt-USDKRW">â€”</span>
        <span class="market-chg" id="mkt-USDKRW-c">â€”</span>
      </div>
      <div class="market-item" onclick="showMarketChart('GC%3DF','ê¸ˆ (Gold)','#f59e0b')">
        <span class="market-name">ê¸ˆ (oz)</span>
        <span class="market-price" id="mkt-GOLD">â€”</span>
        <span class="market-chg" id="mkt-GOLD-c">â€”</span>
      </div>
      <div class="market-item" onclick="showMarketChart('SI%3DF','ì€ (Silver)','#94a3b8')">
        <span class="market-name">ì€ (oz)</span>
        <span class="market-price" id="mkt-SILVER">â€”</span>
        <span class="market-chg" id="mkt-SILVER-c">â€”</span>
      </div>
    </div>

    <div class="summary-grid">
      <div class="summary-card total"><div class="card-icon">ğŸ’°</div><div class="card-label">ì´ ìì‚°</div><div class="card-value" id="s-total">â€”</div><div class="card-change" id="s-total-c">â€”</div></div>
      <div class="summary-card domestic"><div class="card-icon">ğŸ‡°ğŸ‡·</div><div class="card-label">êµ­ë‚´ ì£¼ì‹</div><div class="card-value" id="s-kr">â€”</div><div class="card-change" id="s-kr-c">â€”</div></div>
      <div class="summary-card overseas"><div class="card-icon">ğŸŒ</div><div class="card-label">í•´ì™¸ ì£¼ì‹ (ì›í™”í™˜ì‚°)</div><div class="card-value" id="s-us">â€”</div><div class="card-change" id="s-us-c">â€”</div></div>
      <div class="summary-card crypto"><div class="card-icon">â‚¿</div><div class="card-label">ì•”í˜¸í™”í (ì‹¤ì‹œê°„)</div><div class="card-value" id="s-crypto">â€”</div><div class="card-change" id="s-crypto-c">â€”</div></div>
    </div>

    <div class="main-grid">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ“ˆ ìˆ˜ìµë¥  ì¶”ì´</div>
          <div class="chart-tabs">
            <button class="chart-tab" onclick="switchTab(this,'1W')">1ì£¼</button>
            <button class="chart-tab active" onclick="switchTab(this,'1M')">1ê°œì›”</button>
            <button class="chart-tab" onclick="switchTab(this,'3M')">3ê°œì›”</button>
            <button class="chart-tab" onclick="switchTab(this,'1Y')">1ë…„</button>
          </div>
        </div>
        <div class="card-body"><div class="chart-wrap"><canvas id="returnChart"></canvas></div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ¥§ ìì‚° ë¹„ì¤‘</div></div>
        <div class="card-body">
          <div class="pie-wrap"><canvas id="pieChart"></canvas></div>
          <div class="legend-list">
            <div class="legend-item"><div class="legend-left"><div class="legend-dot" style="background:#3b82f6"></div><span class="legend-name">êµ­ë‚´ ì£¼ì‹</span></div><span class="legend-pct" id="pct-kr">â€”</span></div>
            <div class="legend-item"><div class="legend-left"><div class="legend-dot" style="background:#f59e0b"></div><span class="legend-name">í•´ì™¸ ì£¼ì‹</span></div><span class="legend-pct" id="pct-us">â€”</span></div>
            <div class="legend-item"><div class="legend-left"><div class="legend-dot" style="background:#8b5cf6"></div><span class="legend-name">ì•”í˜¸í™”í</span></div><span class="legend-pct" id="pct-crypto">â€”</span></div>
          </div>
        </div>
      </div>
    </div>

    <div id="section-holdings"></div>
    <div id="section-watchlist"></div>
    <!-- ë³´ìœ /ê´€ì‹¬ ì¢…ëª© íƒ­ í†µí•© -->
    <div class="portfolio-card" style="margin-bottom:20px">
      <div style="padding:0 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--g1)">
        <div style="display:flex;gap:0">
          <button id="htab-holdings" onclick="switchHoldingsTab('holdings')"
            style="padding:16px 20px;font-size:14px;font-weight:700;background:none;border:none;border-bottom:2px solid var(--b6);color:var(--b6);cursor:pointer;font-family:inherit;white-space:nowrap">
            ğŸ’¼ ë³´ìœ  <span id="portfolio-count" style="font-size:11px;color:var(--g4);font-weight:500">0</span>
          </button>
          <button id="htab-watchlist" onclick="switchHoldingsTab('watchlist')"
            style="padding:16px 20px;font-size:14px;font-weight:700;background:none;border:none;border-bottom:2px solid transparent;color:var(--g4);cursor:pointer;font-family:inherit;white-space:nowrap">
            ğŸ‘€ ê´€ì‹¬ <span id="watchlist-count" style="font-size:11px;color:var(--g4);font-weight:500">0</span>
          </button>
        </div>
        <div id="holdings-action-btn">
          <button class="btn-primary" onclick="openModal()" style="font-size:11px;padding:6px 14px">ï¼‹ ì¢…ëª© ì¶”ê°€</button>
        </div>
      </div>

      <!-- ë³´ìœ  ì¢…ëª© íŒ¨ë„ -->
      <div id="panel-holdings">
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="setFilter('all',this)">ì „ì²´</button>
          <button class="filter-tab" onclick="setFilter('kr',this)">ğŸ‡°ğŸ‡· êµ­ë‚´</button>
          <button class="filter-tab" onclick="setFilter('us',this)">ğŸŒ í•´ì™¸</button>
          <button class="filter-tab" onclick="setFilter('crypto',this)">ğŸª™ ì½”ì¸</button>
        </div>
        <table class="portfolio-table">
          <thead>
            <tr>
              <th style="width:32px"></th>
              <th>ì¢…ëª©</th><th>ìœ í˜•</th><th>í˜„ì¬ê°€</th><th>ë³´ìœ ìˆ˜ëŸ‰</th>
              <th>ë§¤ì…ê°€(â‚©)</th><th>í‰ê°€ê¸ˆì•¡</th><th>ìˆ˜ìµë¥ </th><th></th>
            </tr>
          </thead>
          <tbody id="portfolio-body"></tbody>
        </table>
      </div>

      <!-- ê´€ì‹¬ ì¢…ëª© íŒ¨ë„ -->
      <div id="panel-watchlist" style="display:none">
        <table class="portfolio-table">
          <thead>
            <tr>
              <th>ì¢…ëª©</th><th>ìœ í˜•</th><th>í˜„ì¬ê°€</th><th>ëª©í‘œê°€</th><th>ë©”ëª¨</th><th></th>
            </tr>
          </thead>
          <tbody id="watchlist-body"></tbody>
        </table>
      </div>
    </div>

    <div id="section-tx"></div>
    <div class="bottom-grid">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸª™ ì‹¤ì‹œê°„ ì½”ì¸ ì‹œì„¸</div>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:11px;color:#ef4444;font-weight:500">â— LIVE</span>
            <button class="btn-row btn-edit" onclick="openCoinModal()" style="opacity:1;font-size:11px">ï¼‹ ì½”ì¸ ì¶”ê°€</button>
          </div>
        </div>
        <div class="card-body" style="padding-top:10px">
          <table class="portfolio-table">
            <thead><tr><th>ì½”ì¸</th><th>í˜„ì¬ê°€ (KRW)</th><th>24h ë³€ë™</th><th></th></tr></thead>
            <tbody id="coin-body"><tr><td colspan="4" style="text-align:center;color:var(--g4);padding:20px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ”„ ê±°ë˜ ë‚´ì—­</div>
          <button class="btn-row btn-edit" onclick="openTxModal()" style="opacity:1;font-size:11px">ï¼‹ ê±°ë˜ ì¶”ê°€</button>
        </div>
        <div class="card-body" style="padding-top:8px;max-height:300px;overflow-y:auto">
          <div id="tx-list"><div style="text-align:center;color:var(--g4);padding:24px;font-size:13px">ê±°ë˜ ë‚´ì—­ì´ ì—†ì–´ìš”<br><span style="font-size:11px">ï¼‹ ê±°ë˜ ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ë“±ë¡í•˜ì„¸ìš”</span></div></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ê´€ì‹¬ì¢…ëª© ëª¨ë‹¬ -->
<div class="modal-overlay" id="watch-modal-overlay">
  <div class="modal" id="watch-modal-box">
    <div class="modal-header">
      <div class="modal-title" id="watch-modal-title">ê´€ì‹¬ ì¢…ëª© ì¶”ê°€</div>
      <button class="modal-close" onclick="closeWatchModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ìì‚° ìœ í˜•</label>
        <select class="form-select" id="wf-type" onchange="onWatchTypeChange()">
          <option value="kr">ğŸ‡°ğŸ‡· êµ­ë‚´ ì£¼ì‹</option>
          <option value="us">ğŸŒ í•´ì™¸ ì£¼ì‹</option>
          <option value="crypto">ğŸª™ ì•”í˜¸í™”í</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ì¢…ëª©ëª…</label>
          <input class="form-input" id="wf-name" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì"/>
        </div>
        <div class="form-group">
          <label class="form-label" id="wf-ticker-label">í‹°ì»¤/ì¢…ëª©ì½”ë“œ</label>
          <div style="display:flex;gap:8px">
            <input class="form-input" id="wf-ticker" placeholder="ì˜ˆ: 005930" style="flex:1"/>
            <select class="form-select" id="wf-exchange" style="width:100px;display:none">
              <option value="auto">ìë™</option>
              <option value=".KS">ì½”ìŠ¤í”¼</option>
              <option value=".KQ">ì½”ìŠ¤ë‹¥</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ëª©í‘œê°€ (â‚©)</label>
          <input class="form-input" id="wf-target" type="number" placeholder="0 (ì„ íƒì‚¬í•­)"/>
        </div>
        <div class="form-group">
          <label class="form-label">ë©”ëª¨</label>
          <input class="form-input" id="wf-memo" placeholder="ì˜ˆ: ì‹¤ì  ë°œí‘œ í›„ ë§¤ìˆ˜ ê²€í† "/>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="wf-btn-delete" style="display:none;margin-right:auto" onclick="deleteWatchItem()">ğŸ—‘ ì‚­ì œ</button>
      <button class="btn-secondary" onclick="closeWatchModal()">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="saveWatchItem()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ê±°ë˜ë‚´ì—­ ëª¨ë‹¬ -->
<div class="modal-overlay" id="tx-modal-overlay">
  <div class="modal" id="tx-modal-box" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="tx-modal-title">ê±°ë˜ ì¶”ê°€</div>
      <button class="modal-close" onclick="closeTxModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ê±°ë˜ ìœ í˜•</label>
          <select class="form-select" id="tf-type">
            <option value="buy">ğŸ“¥ ë§¤ìˆ˜</option>
            <option value="sell">ğŸ“¤ ë§¤ë„</option>
            <option value="deposit">ğŸ’µ ì…ê¸ˆ</option>
            <option value="withdraw">ğŸ’¸ ì¶œê¸ˆ</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ë‚ ì§œ</label>
          <input class="form-input" id="tf-date" type="date"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ì¢…ëª©ëª…</label>
          <input class="form-input" id="tf-name" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì (ì…ì¶œê¸ˆì‹œ ìƒëµ)"/>
        </div>
        <div class="form-group">
          <label class="form-label">í‹°ì»¤</label>
          <input class="form-input" id="tf-ticker" placeholder="ì˜ˆ: 005930"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ìˆ˜ëŸ‰</label>
          <input class="form-input" id="tf-qty" type="number" step="any" placeholder="0"/>
        </div>
        <div class="form-group">
          <label class="form-label">ë‹¨ê°€ ë˜ëŠ” ê¸ˆì•¡ (â‚©)</label>
          <input class="form-input" id="tf-price" type="number" step="any" placeholder="0"/>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ë©”ëª¨</label>
        <input class="form-input" id="tf-memo" placeholder="ì„ íƒì‚¬í•­"/>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeTxModal()">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="saveTxItem()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ì¢…ëª© ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">ì¢…ëª© ì¶”ê°€</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ìì‚° ìœ í˜•</label>
        <select class="form-select" id="f-type" onchange="onTypeChange()">
          <option value="kr">ğŸ‡°ğŸ‡· êµ­ë‚´ ì£¼ì‹</option>
          <option value="us">ğŸŒ í•´ì™¸ ì£¼ì‹</option>
          <option value="crypto">ğŸª™ ì•”í˜¸í™”í</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ì¢…ëª©ëª…</label>
          <input class="form-input" id="f-name" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì"/>
        </div>
        <div class="form-group">
          <label class="form-label" id="ticker-label">í‹°ì»¤/ì¢…ëª©ì½”ë“œ</label>
          <div style="display:flex;gap:8px">
            <input class="form-input" id="f-ticker" placeholder="ì˜ˆ: 005930" oninput="resetFetchStatus()" style="flex:1"/>
            <select class="form-select" id="f-exchange" style="width:100px;display:none">
              <option value="auto">ìë™</option>
              <option value=".KS">ì½”ìŠ¤í”¼</option>
              <option value=".KQ">ì½”ìŠ¤ë‹¥</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ë³´ìœ  ìˆ˜ëŸ‰</label>
          <input class="form-input" id="f-qty" type="number" step="any" placeholder="0"/>
        </div>
        <div class="form-group">
          <label class="form-label" id="avgbuy-label">í‰ê·  ë§¤ìˆ˜ê°€ (â‚©)</label>
          <input class="form-input" id="f-avgbuy" type="number" step="any" placeholder="0"/>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" id="price-label">
          í˜„ì¬ê°€
          <span id="price-live-badge" style="display:none;font-size:10px;color:var(--gn);font-weight:500">â— ìë™ì—°ë™</span>
        </label>
        <div class="price-auto-row">
          <input class="form-input" id="f-price" type="number" step="any" placeholder="0"/>
          <button class="btn-fetch-price" id="btn-fetch" onclick="fetchPriceForModal()">
            <span>ğŸ”</span><span id="fetch-btn-txt">ì‹œì„¸ ê°€ì ¸ì˜¤ê¸°</span>
          </button>
        </div>
        <div class="fetch-status" id="fetch-status" style="margin-top:6px"></div>
      </div>
      <div class="hint-box" id="modal-hint"></div>
      <div class="form-group" style="margin-top:16px;margin-bottom:0">
        <label class="form-label">ë°°ì§€ ìƒ‰ìƒ</label>
        <div class="color-swatches" id="color-swatches"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="btn-modal-delete" style="display:none;margin-right:auto" onclick="deleteFromModal()">ğŸ—‘ ì‚­ì œ</button>
      <button class="btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="saveItem()">ğŸ’¾ ì €ì¥</button>
    </div>
  </div>
</div>

<!-- âœ… ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (ì™„ì „ ë…ë¦½, z-index:500) -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-icon">ğŸ—‘ï¸</div>
    <div class="confirm-msg" id="confirm-msg">ì‚­ì œí• ê¹Œìš”?</div>
    <div class="confirm-sub">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
    <div class="confirm-btns">
      <button class="btn-secondary" onclick="closeConfirm()">ì·¨ì†Œ</button>
      <button class="btn-danger" onclick="execConfirm()">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ì½”ì¸ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal-overlay" id="coin-modal-overlay">
  <div class="modal" id="coin-modal-box" style="max-width:400px">
    <div class="modal-header">
      <div class="modal-title">ğŸª™ ê´€ì‹¬ ì½”ì¸ ê´€ë¦¬</div>
      <button class="modal-close" onclick="closeCoinModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ì½”ì¸ ì‹¬ë³¼</label>
        <div style="display:flex;gap:8px">
          <input class="form-input" id="coin-input" placeholder="ì˜ˆ: BTC, ETH, SOL" style="flex:1" oninput="this.value=this.value.toUpperCase()"/>
          <button class="btn-primary" onclick="addWatchCoin()" style="padding:10px 16px;font-size:13px">ì¶”ê°€</button>
        </div>
        <div style="font-size:11px;color:var(--g4);margin-top:6px">ì§€ì›: BTC, ETH, SOL, XRP, ADA, DOGE, DOT, AVAX, BNB, LINK, UNI, MATIC</div>
      </div>
      <div id="watch-coin-list" style="display:flex;flex-direction:column;gap:6px;margin-top:4px"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeCoinModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"><span id="toast-icon">âœ…</span><span id="toast-msg"></span></div>

<script>
// â”€â”€ v5 ìºì‹œë²„ìŠ¤í„° 2026-03-01 â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ìƒìˆ˜ / ì´ˆê¸° ë°ì´í„°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS=['#1d4ed8','#0ea5e9','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#f97316','#14b8a6','#1a1a1a','#627eea','#f7931a','#e91e63','#2196f3','#4caf50'];
const COIN_MAP={BTC:'bitcoin',ETH:'ethereum',SOL:'solana',XRP:'ripple',ADA:'cardano',DOGE:'dogecoin',MATIC:'matic-network',DOT:'polkadot',AVAX:'avalanche-2',BNB:'binancecoin',LINK:'chainlink',UNI:'uniswap'};

let currentFilter = 'all';
function setFilter(f, el){
  currentFilter = f;
  document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  render();
}

const DEFAULT_PORTFOLIO=[
  {id:'1',type:'kr',    name:'ì‚¼ì„±ì „ì',  ticker:'005930',qty:80,  avgBuy:66800,  currentPrice:72300, color:'#1d4ed8'},
  {id:'2',type:'kr',    name:'ì¹´ì¹´ì˜¤',    ticker:'035720',qty:120, avgBuy:48000,  currentPrice:46200, color:'#0ea5e9'},
  {id:'3',type:'us',    name:'Apple Inc.',ticker:'AAPL',  qty:15,  avgBuy:277794, currentPrice:0, color:'#1a1a1a'},
  {id:'4',type:'us',    name:'Alphabet',  ticker:'GOOGL', qty:20,  avgBuy:253169, currentPrice:0, color:'#4285f4'},
  {id:'5',type:'crypto',name:'ë¹„íŠ¸ì½”ì¸', ticker:'BTC',   qty:0.03,avgBuy:140200000,currentPrice:0,coinId:'bitcoin', color:'#f7931a'},
  {id:'6',type:'crypto',name:'ì´ë”ë¦¬ì›€', ticker:'ETH',   qty:0.67,avgBuy:3830000, currentPrice:0,coinId:'ethereum',color:'#627eea'},
];

// â”€â”€ Gist ì—°ë™ ì„¤ì • (í† í°ì€ ì½”ë“œì— ì €ì¥í•˜ì§€ ì•ŠìŒ) â”€â”€
const GIST_ID   = '4d3f0aea4fac4d1087053577e795ff0c';
const GIST_FILE = 'wealthboard1.json';

// í† í°ì€ URL íŒŒë¼ë¯¸í„°ì—ì„œ ì½ìŒ (?token=ghp_xxx)
// ì¡°íšŒìëŠ” í† í° ì—†ì´ ì ‘ì† â†’ ì½ê¸° ì „ìš© ìë™ ì ìš©
const URL_TOKEN = new URLSearchParams(window.location.search).get('token') || '';
function getToken(){ return URL_TOKEN; }
const IS_ADMIN = !!URL_TOKEN;

// ê´€ì‹¬ ì½”ì¸ ëª©ë¡ (localStorageì— ì €ì¥)
let watchCoins = JSON.parse(localStorage.getItem('wb_watchcoins') || '["BTC","ETH","SOL","XRP"]');

function saveWatchCoins(){ localStorage.setItem('wb_watchcoins', JSON.stringify(watchCoins)); }

function openCoinModal(){
  renderWatchCoinList();
  document.getElementById('coin-modal-overlay').classList.add('open');
}
function closeCoinModal(){
  document.getElementById('coin-modal-overlay').classList.remove('open');
  fetchCrypto();
}
document.getElementById('coin-modal-overlay').addEventListener('click', e=>{
  if(e.target===document.getElementById('coin-modal-overlay')) closeCoinModal();
});

function addWatchCoin(){
  const sym = document.getElementById('coin-input').value.trim().toUpperCase();
  if(!sym){ showToast('âš ï¸','ì‹¬ë³¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if(watchCoins.includes(sym)){ showToast('âš ï¸','ì´ë¯¸ ì¶”ê°€ëœ ì½”ì¸ì´ì—ìš”'); return; }
  watchCoins.push(sym);
  saveWatchCoins();
  document.getElementById('coin-input').value = '';
  renderWatchCoinList();
  showToast('âœ…', `${sym} ì¶”ê°€ë¨`);
}

function removeWatchCoin(sym){
  watchCoins = watchCoins.filter(c=>c!==sym);
  saveWatchCoins();
  renderWatchCoinList();
}

function renderWatchCoinList(){
  const el = document.getElementById('watch-coin-list');
  if(!watchCoins.length){
    el.innerHTML = '<div style="text-align:center;color:var(--g4);padding:12px;font-size:13px">ì¶”ê°€ëœ ì½”ì¸ì´ ì—†ì–´ìš”</div>';
    return;
  }
  el.innerHTML = watchCoins.map(sym=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--g0);border-radius:8px">
      <span style="font-weight:600;font-size:13px">${sym}</span>
      <button class="btn-row btn-del" onclick="removeWatchCoin('${sym}')" style="opacity:1">ì‚­ì œ</button>
    </div>
  `).join('');
}

let portfolio = [];
let usdKrw = 1380;
let editingId = null;
let selColor = COLORS[0];
let pieInst = null;
let _confirmCb = null;
let isSaving = false;

// â”€â”€ Gist ì½ê¸° â”€â”€
async function loadFromGist(){
  setStatus('gist','loading','Gist ì—°ê²° ì¤‘...');
  if(!IS_ADMIN){
    // í† í° ì—†ìŒ â†’ ì½ê¸° ì „ìš© ëª¨ë“œ
    await loadGistReadOnly();
    return;
  }
  try{
    const r = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
      headers:{ 'Authorization': `token ${getToken()}` }
    });
    if(r.status===401){ setStatus('gist','error','í† í° ì˜¤ë¥˜'); showToast('âš ï¸','í† í°ì´ ì˜ëª»ëì–´ìš” â€” URLì˜ token= ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”'); return; }
    const d = await r.json();
    const content = d.files?.[GIST_FILE]?.content;
    if(content){
      portfolio = JSON.parse(content);
    } else {
      portfolio = DEFAULT_PORTFOLIO;
      await saveToGist();
    }
    setStatus('gist','ok','âœï¸ ê´€ë¦¬ì ëª¨ë“œ');
    const um = document.getElementById('user-mode');
    if(um) um.textContent = 'âœï¸ ê´€ë¦¬ì ëª¨ë“œ';
  }catch(e){
    setStatus('gist','error','Gist ì—°ê²° ì‹¤íŒ¨');
    portfolio = JSON.parse(localStorage.getItem('wb_v4')||'null') || DEFAULT_PORTFOLIO;
    showToast('âš ï¸','Gist ì—°ê²° ì‹¤íŒ¨ â€” ë¡œì»¬ ë°ì´í„° ì‚¬ìš© ì¤‘');
  }
}

// â”€â”€ Gist ì €ì¥ â”€â”€
async function saveToGist(){
  if(!IS_ADMIN){ showToast('âš ï¸','ì½ê¸° ì „ìš© ëª¨ë“œ â€” ìˆ˜ì •í•˜ë ¤ë©´ ê´€ë¦¬ì URLë¡œ ì ‘ì†í•˜ì„¸ìš”'); return; }
  if(isSaving) return;
  isSaving = true;
  setStatus('gist','loading','ì €ì¥ ì¤‘...');
  try{
    const r = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
      method: 'PATCH',
      headers:{
        'Authorization': `token ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        files:{ [GIST_FILE]:{ content: JSON.stringify(portfolio, null, 2) } }
      })
    });
    if(!r.ok) throw new Error('save failed');
    setStatus('gist','ok','âœï¸ ê´€ë¦¬ì ëª¨ë“œ');
    showToast('âœ…','ì €ì¥ë¨');
  }catch(e){
    setStatus('gist','error','ì €ì¥ ì‹¤íŒ¨');
    showToast('âš ï¸','ì €ì¥ ì‹¤íŒ¨ â€” ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”');
  } finally {
    isSaving = false;
  }
}

function saveLocal(){ saveToGist(); }

function setStatus(id, state, label){
  const dot = document.getElementById('dot-'+id);
  const lbl = document.getElementById('lbl-'+id);
  if(dot) dot.className = 'api-dot ' + state;
  if(lbl) lbl.textContent = label;
}

async function loadGistReadOnly(){
  setStatus('gist','loading','Gist ì½ëŠ” ì¤‘...');
  try{
    // í† í° ì—†ì´ raw URLë¡œ ì½ê¸°
    const r = await fetch(`https://gist.githubusercontent.com/neurostar01/${GIST_ID}/raw/${GIST_FILE}`);
    if(!r.ok) throw new Error('ì½ê¸° ì‹¤íŒ¨');
    portfolio = await r.json();
    setStatus('gist','ok','ğŸ‘ ì½ê¸° ì „ìš©');
    const um = document.getElementById('user-mode');
    if(um) um.textContent = 'ğŸ‘ ì½ê¸° ì „ìš©';
    // í¸ì§‘ UI ìˆ¨ê¸°ê¸°
    document.querySelectorAll('[onclick*="openModal"],[onclick*="fetchLive"]').forEach(el=>{
      if(el.tagName==='BUTTON' && el.textContent.includes('ì¶”ê°€')) el.style.display='none';
    });
    await fetchLive();
  }catch(e){
    setStatus('gist','error','ì½ê¸° ì‹¤íŒ¨');
    showToast('âš ï¸','Gist ì½ê¸° ì‹¤íŒ¨');
    portfolio = DEFAULT_PORTFOLIO;
    render();
  }
}



// ë‚ ì§œ
const td = new Date();
document.getElementById('current-date').textContent =
  `${td.getFullYear()}. ${String(td.getMonth()+1).padStart(2,'0')}. ${String(td.getDate()).padStart(2,'0')}`;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (ì™„ì „ ë…ë¦½)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showConfirm(msg, cb){
  _confirmCb = cb;
  document.getElementById('confirm-msg').textContent = msg;
  document.getElementById('confirm-overlay').classList.add('open');
}
function closeConfirm(){
  document.getElementById('confirm-overlay').classList.remove('open');
  _confirmCb = null;
}
function execConfirm(){
  const cb = _confirmCb;
  closeConfirm();
  if(cb) cb();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API ìƒíƒœ ë„íŠ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDot(id, s){ const e=document.getElementById(id); if(e) e.className='api-dot '+s; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í™˜ìœ¨
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchFX(){
  setDot('dot-fx','loading');
  try{
    const r = await fetch('https://open.er-api.com/v6/latest/USD');
    const d = await r.json();
    usdKrw = d.rates.KRW;
    setDot('dot-fx','ok');
  }catch{ setDot('dot-fx','error'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Yahoo Finance ê³µí†µ í˜¸ì¶œ â€” ì „ìš© Cloudflare Worker í”„ë¡ì‹œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXY_URL = 'https://yahoo-proxy.medi0204.workers.dev';

async function yahooFetch(symbol){
  try{
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), 8000);
    const r = await fetch(`${PROXY_URL}/?symbol=${encodeURIComponent(symbol)}`, {signal: ctrl.signal});
    clearTimeout(timer);
    if(!r.ok) return null;
    const d = await r.json();
    if(d.error) return null;
    return d.price ?? null;
  }catch{ return null; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í•´ì™¸ì£¼ì‹ ì‹œì„¸ â€” USD ë°˜í™˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchUSPrice(ticker){
  return await yahooFetch(ticker);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// êµ­ë‚´ì£¼ì‹ ì‹œì„¸ â€” exchange ì§€ì •ì‹œ í•´ë‹¹ ê±°ë˜ì†Œë§Œ, ì—†ìœ¼ë©´ KQâ†’KS ìˆœ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchKRPrice(ticker, exchange='auto'){
  if(exchange === '.KS'){
    return await yahooFetchVerified(ticker + '.KS', ticker);
  }
  if(exchange === '.KQ'){
    return await yahooFetchVerified(ticker + '.KQ', ticker);
  }
  // auto: KQ ë¨¼ì €, ì‹¤íŒ¨ì‹œ KS
  const priceKQ = await yahooFetchVerified(ticker + '.KQ', ticker);
  if(priceKQ) return priceKQ;
  return await yahooFetchVerified(ticker + '.KS', ticker);
}

// symbol ê²€ì¦ í¬í•¨ ì¡°íšŒ â€” í‹°ì»¤ì½”ë“œê°€ ì‘ë‹µì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
async function yahooFetchVerified(symbol, ticker){
  try{
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), 8000);
    const r = await fetch(`${PROXY_URL}/?symbol=${encodeURIComponent(symbol)}`, {signal: ctrl.signal});
    clearTimeout(timer);
    if(!r.ok) return null;
    const d = await r.json();
    if(d.error || !d.price || d.price <= 0) return null;
    // ê²€ì¦ 1: symbolì´ tickerë¡œ ì‹œì‘í•´ì•¼ í•¨
    if(d.symbol && !d.symbol.startsWith(ticker)) return null;
    // ê²€ì¦ 2: nameì´ ë¹„ì–´ìˆìœ¼ë©´ ì—‰ëš±í•œ ì¢…ëª©
    if(!d.name || d.name.trim() === '') return null;
    // ê²€ì¦ 3: í†µí™”ê°€ KRWì¸ì§€ í™•ì¸ (USD ë“±ì´ë©´ ì—‰ëš±í•œ ì¢…ëª©)
    if(d.currency && d.currency !== 'KRW') return null;
    return d.price;
  }catch{ return null; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì½”ì¸ ì‹œì„¸ (CoinGecko)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchCrypto(){
  setDot('dot-crypto','loading');

  // ë³´ìœ  ì½”ì¸ + ê´€ì‹¬ ì½”ì¸ í•©ì¹˜ê¸°
  const portfolioCoinIds = portfolio.filter(p=>p.type==='crypto'&&p.coinId).map(p=>p.coinId);
  const watchCoinIds = watchCoins.map(sym => COIN_MAP[sym] || sym.toLowerCase());
  const allIds = [...new Set([...portfolioCoinIds, ...watchCoinIds])];

  if(!allIds.length){ setDot('dot-crypto','ok'); return; }
  try{
    const r = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=krw&ids=${allIds.join(',')}&price_change_percentage=24h`);
    const data = await r.json();

    // ë³´ìœ  ì½”ì¸ ê°€ê²© ì—…ë°ì´íŠ¸
    data.forEach(coin=>{
      portfolio.forEach(p=>{ if(p.coinId===coin.id){ p.currentPrice=coin.current_price; p.change24h=coin.price_change_percentage_24h; p.image=coin.image; } });
    });

    // ì½”ì¸ ì‹œì„¸ í…Œì´ë¸” ë Œë” (ê´€ì‹¬ ì½”ì¸ ê¸°ì¤€)
    const displayCoins = watchCoins.map(sym=>{
      const id = COIN_MAP[sym] || sym.toLowerCase();
      return data.find(c=>c.id===id);
    }).filter(Boolean);

    if(!displayCoins.length){
      document.getElementById('coin-body').innerHTML=`<tr><td colspan="4" style="text-align:center;color:var(--g4);padding:20px">ì½”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš” (ï¼‹ ë²„íŠ¼)</td></tr>`;
    } else {
      document.getElementById('coin-body').innerHTML = displayCoins.map(c=>{
        const ch=c.price_change_percentage_24h, isUp=ch>=0;
        return `<tr>
          <td><div style="display:flex;align-items:center;gap:8px">
            <img src="${c.image}" width="24" height="24" style="border-radius:50%" onerror="this.style.display='none'">
            <div><div style="font-size:13px;font-weight:600">${c.name}</div><div class="stock-ticker">${c.symbol.toUpperCase()}</div></div>
          </div></td>
          <td class="text-mono">â‚©${c.current_price.toLocaleString()}</td>
          <td><span class="tag ${isUp?'tag-up':'tag-down'}">${isUp?'â–²':'â–¼'} ${Math.abs(ch).toFixed(2)}%</span></td>
          <td><button class="btn-row btn-del" onclick="removeWatchCoin('${c.symbol.toUpperCase()}');fetchCrypto();" style="opacity:1;font-size:10px">âœ•</button></td>
        </tr>`;
      }).join('');
    }
    setDot('dot-crypto','ok');
  }catch{
    setDot('dot-crypto','error');
    document.getElementById('coin-body').innerHTML=`<tr><td colspan="4" style="text-align:center;color:var(--rd);padding:16px">âš ï¸ API ì—°ê²° ì‹¤íŒ¨</td></tr>`;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì „ì²´ ì£¼ì‹ ì‹œì„¸ ìë™ ì—…ë°ì´íŠ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAllStockPrices(){
  const usStocks = portfolio.filter(p=>p.type==='us');
  const krStocks = portfolio.filter(p=>p.type==='kr');

  // í•´ì™¸ì£¼ì‹
  setDot('dot-us','loading');
  let usOk=0;
  await Promise.all(usStocks.map(async p=>{
    const price = await fetchUSPrice(p.ticker);
    if(price!==null){ p.currentPrice=price; usOk++; }
  }));
  setDot('dot-us', usOk>0||usStocks.length===0 ? 'ok' : 'error');

  // êµ­ë‚´ì£¼ì‹
  setDot('dot-kr','loading');
  let krOk=0;
  await Promise.all(krStocks.map(async p=>{
    const price = await fetchKRPrice(p.ticker, p.exchange || 'auto');
    if(price!==null){ p.currentPrice=price; krOk++; }
  }));
  setDot('dot-kr', krOk>0||krStocks.length===0 ? 'ok' : 'error');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ëª¨ë‹¬ ì•ˆ "ì‹œì„¸ ê°€ì ¸ì˜¤ê¸°" ë²„íŠ¼
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchPriceForModal(){
  const type   = document.getElementById('f-type').value;
  const ticker = document.getElementById('f-ticker').value.trim().toUpperCase();
  if(!ticker){ setFetchStatus('err','í‹°ì»¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  const btn = document.getElementById('btn-fetch');
  btn.disabled = true;
  document.getElementById('fetch-btn-txt').textContent = 'ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
  setFetchStatus('','');

  try{
    let price = null;
    if(type==='us'){
      price = await fetchUSPrice(ticker);
    } else if(type==='kr'){
      const exch = document.getElementById('f-exchange').value;
      price = await fetchKRPrice(ticker, exch);
      if(price===null){
        // ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨ ì‹œ ë„¤ì´ë²„ ê¸ˆìœµ ë§í¬ ì•ˆë‚´
        setFetchStatus('err',`âš ï¸ ìë™ ì¡°íšŒ ì‹¤íŒ¨ â€” <a href="https://finance.naver.com/item/main.naver?code=${ticker}" target="_blank" style="color:var(--b5)">ë„¤ì´ë²„ ê¸ˆìœµì—ì„œ í™•ì¸ â†’</a>`);
        document.getElementById('fetch-status').innerHTML = document.getElementById('fetch-status').textContent;
        document.getElementById('fetch-status').innerHTML = `âš ï¸ ìë™ ì¡°íšŒ ì‹¤íŒ¨ â€” <a href="https://finance.naver.com/item/main.naver?code=${ticker}" target="_blank" style="color:var(--b5)">ë„¤ì´ë²„ ê¸ˆìœµì—ì„œ ì§ì ‘ í™•ì¸ í›„ ì…ë ¥ â†’</a>`;
        btn.disabled = false;
        document.getElementById('fetch-btn-txt').textContent = 'ì‹œì„¸ ê°€ì ¸ì˜¤ê¸°';
        return;
      }
    } else if(type==='crypto'){
      const coinId = COIN_MAP[ticker] || ticker.toLowerCase();
      const r = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=krw`);
      const d = await r.json();
      price = d[coinId]?.krw ?? null;
    }

    if(price!==null && price>0){
      document.getElementById('f-price').value = price;
      const dispPrice = type==='us' ? `$${price.toLocaleString()} (â‰ˆ â‚©${Math.round(price*usdKrw).toLocaleString()})` : `â‚©${price.toLocaleString()}`;
        setFetchStatus('ok', `âœ… ${dispPrice} â€” ì‹œì„¸ ë°˜ì˜ ì™„ë£Œ`);
    } else {
      setFetchStatus('err','âš ï¸ ì‹œì„¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í‹°ì»¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”');
    }
  }catch{
    setFetchStatus('err','âŒ ì—°ê²° ì˜¤ë¥˜. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
  }

  btn.disabled = false;
  document.getElementById('fetch-btn-txt').textContent = 'ì‹œì„¸ ê°€ì ¸ì˜¤ê¸°';
}

function setFetchStatus(cls, msg){
  const el = document.getElementById('fetch-status');
  el.className = 'fetch-status' + (cls ? ' '+cls : '');
  el.textContent = msg;
}
function resetFetchStatus(){ setFetchStatus('',''); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë Œë”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  const kr = portfolio.filter(p=>p.type==='kr');
  const us = portfolio.filter(p=>p.type==='us');
  const cr = portfolio.filter(p=>p.type==='crypto');
  const krT = kr.reduce((s,p)=>s+p.qty*p.currentPrice,0);
  const usT = us.reduce((s,p)=>s+p.qty*p.currentPrice*usdKrw,0);
  const crT = cr.reduce((s,p)=>s+p.qty*p.currentPrice,0);
  const tot = krT+usT+crT;

  setTxt('s-total',`â‚©${Math.round(tot).toLocaleString()}`);
  setTxt('s-kr',`â‚©${Math.round(krT).toLocaleString()}`);
  setTxt('s-us',`â‚©${Math.round(usT).toLocaleString()}`);
  setTxt('s-crypto',`â‚©${Math.round(crT).toLocaleString()}`);

  const krC=kr.reduce((s,p)=>s+p.qty*p.avgBuy,0);
  const usC=us.reduce((s,p)=>s+p.qty*p.avgBuy,0);  // avgBuy ì›í™”
  const crC=cr.reduce((s,p)=>s+p.qty*p.avgBuy,0);
  const totC=krC+usC+crC;
  setChg('s-total-c',tot-totC,totC);
  setChg('s-kr-c',krT-krC,krC);
  setChg('s-us-c',usT-usC,usC);
  setChg('s-crypto-c',crT-crC,crC);

  const pKr=tot?(krT/tot*100).toFixed(1):0;
  const pUs=tot?(usT/tot*100).toFixed(1):0;
  const pCr=tot?(crT/tot*100).toFixed(1):0;
  setTxt('pct-kr',pKr+'%'); setTxt('pct-us',pUs+'%'); setTxt('pct-crypto',pCr+'%');
  if(pieInst){ pieInst.data.datasets[0].data=[+pKr,+pUs,+pCr]; pieInst.update(); }

  setTxt('portfolio-count',`${portfolio.length}ì¢…ëª©`);

  const filtered = currentFilter==='all' ? portfolio : portfolio.filter(p=>p.type===currentFilter);

  if(!portfolio.length){
    document.getElementById('portfolio-body').innerHTML=`<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">ì•„ì§ ì¢…ëª©ì´ ì—†ì–´ìš”</div><div class="empty-sub">+ ì¢…ëª© ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ì²« ì¢…ëª©ì„ ë“±ë¡í•´ë³´ì„¸ìš”</div></div></td></tr>`;
    return;
  }
  if(!filtered.length){
    document.getElementById('portfolio-body').innerHTML=`<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ğŸ”</div><div class="empty-title">í•´ë‹¹ ìœ í˜•ì˜ ì¢…ëª©ì´ ì—†ì–´ìš”</div></div></td></tr>`;
    return;
  }

  document.getElementById('portfolio-body').innerHTML = filtered.map(p=>{
    // avgBuyëŠ” í•­ìƒ ì›í™”ë¡œ ì €ì¥ (í•´ì™¸ì£¼ì‹ í¬í•¨)
    const evalKrw = p.type==='us' ? p.qty*p.currentPrice*usdKrw : p.qty*p.currentPrice;
    const costKrw = p.qty * p.avgBuy;  // avgBuy í•­ìƒ ì›í™”
    const pct = costKrw ? (evalKrw-costKrw)/costKrw*100 : 0;
    const prStr = p.type==='us' && p.currentPrice>0
      ? `<span title="$${p.currentPrice.toLocaleString()}">â‚©${Math.round(p.currentPrice*usdKrw).toLocaleString()}</span>`
      : `â‚©${Math.round(p.currentPrice).toLocaleString()}`;
    const avStr = `â‚©${Math.round(p.avgBuy).toLocaleString()}`;
    const qStr  = p.type==='crypto' ? `${p.qty} ${p.ticker}` : `${p.qty}ì£¼`;
    const badge = p.type==='kr'?'badge-kr':p.type==='us'?'badge-us':'badge-crypto';
    const bTxt  = p.type==='kr'?'êµ­ë‚´':p.type==='us'?'í•´ì™¸':'ì½”ì¸';
    const liveBadge = (p.type==='crypto'||p.type==='us'||p.type==='kr') && p.currentPrice>0
      ? `<span class="price-live">â— LIVE</span>` : '';
    return `<tr draggable="true" data-id="${p.id}">
      <td><span class="drag-handle" title="ë“œë˜ê·¸í•´ì„œ ìˆœì„œ ë³€ê²½">â ¿</span></td>
      <td><div class="stock-info">
        <div class="stock-badge" style="background:${p.color}">${p.name[0]}</div>
        <div><div class="stock-name">${p.name}</div><div class="stock-ticker">${p.ticker}${liveBadge}</div></div>
      </div></td>
      <td><span class="badge-type ${badge}">${bTxt}</span></td>
      <td class="text-mono">${prStr}</td>
      <td class="text-mono">${qStr}</td>
      <td class="text-mono">${avStr}</td>
      <td class="text-mono">â‚©${Math.round(evalKrw).toLocaleString()}</td>
      <td class="${pct>=0?'text-up':'text-down'}">${pct>=0?'â–²':'â–¼'} ${Math.abs(pct).toFixed(2)}%</td>
      <td style="text-align:right"><div class="row-actions">
        <button class="btn-row btn-edit" data-action="edit" data-id="${p.id}">ìˆ˜ì •</button>
        <button class="btn-row btn-del"  data-action="del"  data-id="${p.id}">ì‚­ì œ</button>
      </div></td>
    </tr>`;
  }).join('');
  initDrag();
}

// â”€â”€ ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½ â”€â”€
function initDrag(){
  const tbody = document.getElementById('portfolio-body');
  let dragSrc = null;
  tbody.querySelectorAll('tr[draggable]').forEach(row=>{
    row.addEventListener('dragstart', e=>{
      dragSrc = row;
      row.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
    });
    row.addEventListener('dragend', ()=>{
      row.classList.remove('dragging');
      tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('drag-over'));
    });
    row.addEventListener('dragover', e=>{
      e.preventDefault();
      if(row!==dragSrc){
        tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('drag-over'));
        row.classList.add('drag-over');
      }
    });
    row.addEventListener('drop', e=>{
      e.preventDefault();
      if(dragSrc && row!==dragSrc){
        const srcId = dragSrc.dataset.id;
        const tgtId = row.dataset.id;
        const srcIdx = portfolio.findIndex(p=>p.id===srcId);
        const tgtIdx = portfolio.findIndex(p=>p.id===tgtId);
        if(srcIdx!==-1 && tgtIdx!==-1){
          const [item] = portfolio.splice(srcIdx,1);
          portfolio.splice(tgtIdx,0,item);
          saveLocal();
          render();
        }
      }
    });
  });
}

// ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ìˆ˜ì •/ì‚­ì œ
document.getElementById('portfolio-body').addEventListener('click', e=>{
  const btn = e.target.closest('[data-action]');
  if(!btn) return;
  e.stopPropagation();
  const id = btn.dataset.id;
  if(btn.dataset.action==='edit') openModal(id);
  else if(btn.dataset.action==='del') delItem(id);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id=null){
  editingId = id;
  const item = id ? portfolio.find(p=>p.id===id) : null;
  document.getElementById('modal-title').textContent = id ? 'ì¢…ëª© ìˆ˜ì •' : 'ì¢…ëª© ì¶”ê°€';
  document.getElementById('btn-modal-delete').style.display = id ? 'block' : 'none';
  setFetchStatus('','');

  if(item){
    document.getElementById('f-type').value    = item.type;
    document.getElementById('f-name').value    = item.name;
    document.getElementById('f-ticker').value  = item.ticker;
    document.getElementById('f-exchange').value = item.exchange || 'auto';
    document.getElementById('f-qty').value     = item.qty;
    document.getElementById('f-avgbuy').value  = item.avgBuy;
    document.getElementById('f-price').value   = item.currentPrice || '';
    selColor = item.color;
  } else {
    document.getElementById('f-type').value = 'kr';
    ['f-name','f-ticker','f-qty','f-avgbuy','f-price'].forEach(fid=>document.getElementById(fid).value='');
    selColor = COLORS[0];
  }
  onTypeChange();
  renderSwatches();
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal(){
  document.getElementById('modal-overlay').classList.remove('open');
  editingId = null;
}

// ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸° (ëª¨ë‹¬ ë°•ìŠ¤ í´ë¦­ì€ ë¬´ì‹œ)
document.getElementById('modal-overlay').addEventListener('click', e=>{
  if(e.target === document.getElementById('modal-overlay')) closeModal();
});

function onTypeChange(){
  const t = document.getElementById('f-type').value;
  const hint = document.getElementById('modal-hint');
  const badge = document.getElementById('price-live-badge');
  document.getElementById('f-exchange').style.display = 'none';
  if(t==='crypto'){
    document.getElementById('ticker-label').textContent = 'ì½”ì¸ ì‹¬ë³¼ (BTC, ETH, SOLâ€¦)';
    document.getElementById('avgbuy-label').textContent = 'í‰ê·  ë§¤ìˆ˜ê°€ (â‚©)';
    document.getElementById('price-label').childNodes[0].textContent = 'í˜„ì¬ê°€ (KRW) ';
    badge.style.display='inline';
    hint.innerHTML='ğŸ’¡ ì½”ì¸ ì‹¬ë³¼ ì…ë ¥ í›„ <strong>"ì‹œì„¸ ê°€ì ¸ì˜¤ê¸°"</strong>ë¥¼ ëˆ„ë¥´ë©´ CoinGeckoì—ì„œ ìë™ìœ¼ë¡œ í˜„ì¬ê°€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.';
  } else if(t==='us'){
    document.getElementById('ticker-label').textContent = 'í‹°ì»¤ ì‹¬ë³¼ (AAPL, TSLA, NVDAâ€¦)';
    document.getElementById('avgbuy-label').textContent = 'ë§¤ì…ê°€ (â‚© ì›í™”) â€” ë§¤ìˆ˜ ë‹¹ì‹œ í™˜ìœ¨ ê¸°ì¤€';
    document.getElementById('price-label').childNodes[0].textContent = 'í˜„ì¬ê°€ (USD, ìë™ì¡°íšŒ) ';
    badge.style.display='inline';
    hint.innerHTML='ğŸ’¡ <strong>ë§¤ì…ê°€ëŠ” ì›í™”ë¡œ ì…ë ¥</strong>í•´ì£¼ì„¸ìš” (ë§¤ìˆ˜ ë‹¹ì‹œ ë‹¬ëŸ¬Ã—í™˜ìœ¨). í˜„ì¬ê°€ëŠ” ë‹¬ëŸ¬ë¡œ ìë™ ì¡°íšŒ í›„ í˜„ì¬ í™˜ìœ¨ë¡œ ì›í™” í™˜ì‚°í•©ë‹ˆë‹¤.';
  } else {
    document.getElementById('ticker-label').textContent = 'ì¢…ëª©ì½”ë“œ + ê±°ë˜ì†Œ';
    document.getElementById('avgbuy-label').textContent = 'í‰ê·  ë§¤ìˆ˜ê°€ (â‚©)';
    document.getElementById('price-label').childNodes[0].textContent = 'í˜„ì¬ê°€ (KRW) ';
    document.getElementById('f-exchange').style.display = 'block';
    badge.style.display='inline';
    hint.innerHTML='ğŸ’¡ ì¢…ëª©ì½”ë“œ ì…ë ¥ í›„ ê±°ë˜ì†Œ(ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥)ë¥¼ ì„ íƒí•˜ê³  <strong>"ì‹œì„¸ ê°€ì ¸ì˜¤ê¸°"</strong>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
  }
  resetFetchStatus();
}

function renderSwatches(){
  document.getElementById('color-swatches').innerHTML = COLORS.map(c=>
    `<div class="swatch${c===selColor?' selected':''}" style="background:${c}" onclick="pickColor('${c}')"></div>`
  ).join('');
}
function pickColor(c){ selColor=c; renderSwatches(); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì €ì¥
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveItem(){
  const type   = document.getElementById('f-type').value;
  const name   = document.getElementById('f-name').value.trim();
  const ticker = document.getElementById('f-ticker').value.trim().toUpperCase();
  const qty    = parseFloat(document.getElementById('f-qty').value)||0;
  const avgBuy = parseFloat(document.getElementById('f-avgbuy').value)||0;  // í•­ìƒ ì›í™”
  const price  = parseFloat(document.getElementById('f-price').value)||0;   // í•´ì™¸ëŠ” ë‹¬ëŸ¬, ë‚˜ë¨¸ì§€ ì›í™”
  if(!name||!ticker||!qty||!avgBuy){ showToast('âš ï¸','ì¢…ëª©ëª…, í‹°ì»¤, ìˆ˜ëŸ‰, ë§¤ì…ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const exchange = document.getElementById('f-exchange').value;
  const item = {
    id: editingId || String(Date.now()),
    type, name, ticker, qty,
    avgBuy,
    currentPrice: price,
    color: selColor,
    ...(type==='kr' && {exchange}),
    ...(type==='crypto' && {coinId: COIN_MAP[ticker] || ticker.toLowerCase()})
  };
  if(editingId){
    const i = portfolio.findIndex(p=>p.id===editingId);
    if(i!==-1) portfolio[i] = item;
    showToast('âœ…',`${name} ìˆ˜ì • ì™„ë£Œ`);
  } else {
    portfolio.push(item);
    showToast('âœ…',`${name} ì¶”ê°€ ì™„ë£Œ`);
  }
  saveLocal();
  closeModal();
  fetchLive();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì‚­ì œ â€” showConfirm ì‚¬ìš© (confirm() ì™„ì „ ì œê±°)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function delItem(id){
  const item = portfolio.find(p=>p.id===id);
  if(!item) return;
  showConfirm(`"${item.name}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`, ()=>{
    portfolio = portfolio.filter(p=>p.id!==id);
    saveLocal();
    render();
    showToast('ğŸ—‘ï¸',`${item.name} ì‚­ì œë¨`);
  });
}

function deleteFromModal(){
  if(!editingId) return;
  const item = portfolio.find(p=>p.id===editingId);
  if(!item) return;
  showConfirm(`"${item.name}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`, ()=>{
    portfolio = portfolio.filter(p=>p.id!==editingId);
    saveLocal();
    closeModal();
    render();
    showToast('ğŸ—‘ï¸',`${item.name} ì‚­ì œë¨`);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ìœ í‹¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTxt(id,v){ const e=document.getElementById(id); if(e) e.textContent=v; }
function setChg(id,diff,cost){
  const e=document.getElementById(id); if(!e||!cost) return;
  const pct=(diff/cost*100).toFixed(2), isUp=diff>=0;
  e.className=`card-change ${isUp?'up':'down'}`;
  e.textContent=`${isUp?'â–²':'â–¼'} ${isUp?'+':''}${Math.round(diff).toLocaleString()} (${isUp?'+':''}${pct}%)`;
}
function showToast(icon,msg){
  document.getElementById('toast-icon').textContent=icon;
  document.getElementById('toast-msg').textContent=msg;
  const t=document.getElementById('toast');
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì°¨íŠ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const rCtx = document.getElementById('returnChart').getContext('2d');
const grad = rCtx.createLinearGradient(0,0,0,220);
grad.addColorStop(0,'rgba(59,130,246,.18)'); grad.addColorStop(1,'rgba(59,130,246,0)');
const CD={
  '1W':{labels:['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'],data:[55800000,56200000,55900000,57100000,57800000,58100000,58420000]},
  '1M':{labels:['1','3','5','7','9','11','13','15','17','19','21','23','24'],data:[53200000,54000000,53500000,55200000,54800000,56000000,55700000,57100000,56900000,57800000,58100000,57900000,58420000]},
  '3M':{labels:['11ì›”','12ì›”','1ì›”','2ì›”'],data:[49000000,51500000,55000000,58420000]},
  '1Y':{labels:['3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”','1ì›”','2ì›”'],data:[38000000,40500000,41200000,43000000,42500000,44800000,46200000,47900000,49000000,51500000,55000000,58420000]}
};
let rChart = new Chart(rCtx,{type:'line',data:{labels:CD['1M'].labels,datasets:[{data:CD['1M'].data,borderColor:'#3b82f6',backgroundColor:grad,borderWidth:2.5,pointRadius:0,pointHoverRadius:5,fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`â‚©${ctx.raw.toLocaleString()}`},backgroundColor:'#1e293b',titleColor:'#94a3b8',bodyColor:'#fff',padding:10,borderRadius:8}},scales:{x:{grid:{display:false},ticks:{color:'#94a3b8',font:{size:11}},border:{display:false}},y:{grid:{color:'#f1f5f9'},ticks:{color:'#94a3b8',font:{size:11},callback:v=>`â‚©${(v/10000000).toFixed(1)}ì²œë§Œ`},border:{display:false}}}}});

function switchTab(el,p){
  document.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  rChart.data.labels=CD[p].labels; rChart.data.datasets[0].data=CD[p].data; rChart.update();
}

const pCtx = document.getElementById('pieChart').getContext('2d');
pieInst = new Chart(pCtx,{type:'doughnut',data:{labels:['êµ­ë‚´','í•´ì™¸','ì½”ì¸'],datasets:[{data:[37.9,51.1,11.0],backgroundColor:['#3b82f6','#f59e0b','#8b5cf6'],borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,cutout:'68%',plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw}%`},backgroundColor:'#1e293b',bodyColor:'#fff',padding:10,borderRadius:8}}}});


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê´€ì‹¬ ì¢…ëª© (watchlist)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let watchlist = JSON.parse(localStorage.getItem('wb_watchlist') || '[]');
let watchEditId = null;

function saveWatchlist(){ localStorage.setItem('wb_watchlist', JSON.stringify(watchlist)); }

function openWatchModal(id=null){
  watchEditId = id;
  const item = id ? watchlist.find(w=>w.id===id) : null;
  document.getElementById('watch-modal-title').textContent = id ? 'ê´€ì‹¬ ì¢…ëª© ìˆ˜ì •' : 'ê´€ì‹¬ ì¢…ëª© ì¶”ê°€';
  document.getElementById('wf-btn-delete').style.display = id ? 'block' : 'none';
  if(item){
    document.getElementById('wf-type').value = item.type;
    document.getElementById('wf-name').value = item.name;
    document.getElementById('wf-ticker').value = item.ticker;
    document.getElementById('wf-exchange').value = item.exchange || 'auto';
    document.getElementById('wf-target').value = item.target || '';
    document.getElementById('wf-memo').value = item.memo || '';
  } else {
    document.getElementById('wf-type').value = 'kr';
    ['wf-name','wf-ticker','wf-target','wf-memo'].forEach(id=>document.getElementById(id).value='');
  }
  onWatchTypeChange();
  document.getElementById('watch-modal-overlay').classList.add('open');
}
function closeWatchModal(){ document.getElementById('watch-modal-overlay').classList.remove('open'); watchEditId=null; }
document.getElementById('watch-modal-overlay').addEventListener('click', e=>{
  if(e.target===document.getElementById('watch-modal-overlay')) closeWatchModal();
});

function onWatchTypeChange(){
  const t = document.getElementById('wf-type').value;
  const exEl = document.getElementById('wf-exchange');
  if(t==='kr'){
    document.getElementById('wf-ticker-label').textContent = 'ì¢…ëª©ì½”ë“œ';
    exEl.style.display='block';
  } else if(t==='us'){
    document.getElementById('wf-ticker-label').textContent = 'í‹°ì»¤ ì‹¬ë³¼';
    exEl.style.display='none';
  } else {
    document.getElementById('wf-ticker-label').textContent = 'ì½”ì¸ ì‹¬ë³¼';
    exEl.style.display='none';
  }
}

function saveWatchItem(){
  const type = document.getElementById('wf-type').value;
  const name = document.getElementById('wf-name').value.trim();
  const ticker = document.getElementById('wf-ticker').value.trim().toUpperCase();
  const target = parseFloat(document.getElementById('wf-target').value)||0;
  const memo = document.getElementById('wf-memo').value.trim();
  const exchange = document.getElementById('wf-exchange').value;
  if(!name||!ticker){ showToast('âš ï¸','ì¢…ëª©ëª…ê³¼ í‹°ì»¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const item = { id: watchEditId||String(Date.now()), type, name, ticker, target, memo, currentPrice:0,
    ...(type==='kr'&&{exchange}),
    ...(type==='crypto'&&{coinId: COIN_MAP[ticker]||ticker.toLowerCase()})
  };
  if(watchEditId){
    const i=watchlist.findIndex(w=>w.id===watchEditId); if(i!==-1) watchlist[i]=item;
    showToast('âœ…',`${name} ìˆ˜ì •ë¨`);
  } else {
    watchlist.push(item);
    showToast('âœ…',`${name} ê´€ì‹¬ ì¢…ëª© ì¶”ê°€ë¨`);
  }
  saveWatchlist();
  closeWatchModal();
  fetchWatchlistPrices();
}

function deleteWatchItem(){
  if(!watchEditId) return;
  const item = watchlist.find(w=>w.id===watchEditId);
  showConfirm(`"${item?.name}" ê´€ì‹¬ ì¢…ëª©ì„ ì‚­ì œí• ê¹Œìš”?`, ()=>{
    watchlist = watchlist.filter(w=>w.id!==watchEditId);
    saveWatchlist();
    closeWatchModal();
    renderWatchlist();
    showToast('ğŸ—‘ï¸','ì‚­ì œë¨');
  });
}

async function fetchWatchlistPrices(){
  await Promise.all(watchlist.map(async w=>{
    if(w.type==='kr') w.currentPrice = await fetchKRPrice(w.ticker, w.exchange||'auto') || w.currentPrice;
    else if(w.type==='us') w.currentPrice = await fetchUSPrice(w.ticker) || w.currentPrice;
    else if(w.type==='crypto'){
      const id = w.coinId||COIN_MAP[w.ticker]||w.ticker.toLowerCase();
      try{
        const r=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=krw`);
        const d=await r.json(); w.currentPrice=d[id]?.krw||w.currentPrice;
      }catch{}
    }
  }));
  renderWatchlist();
}

function renderWatchlist(){
  setTxt('watchlist-count',`${watchlist.length}ì¢…ëª©`);
  const el = document.getElementById('watchlist-body');
  if(!watchlist.length){
    el.innerHTML=`<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">ğŸ‘€</div><div class="empty-title">ê´€ì‹¬ ì¢…ëª©ì´ ì—†ì–´ìš”</div><div class="empty-sub">ï¼‹ ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ë“±ë¡í•´ë³´ì„¸ìš”</div></div></td></tr>`;
    return;
  }
  el.innerHTML = watchlist.map(w=>{
    const badge = w.type==='kr'?'badge-kr':w.type==='us'?'badge-us':'badge-crypto';
    const bTxt = w.type==='kr'?'êµ­ë‚´':w.type==='us'?'í•´ì™¸':'ì½”ì¸';
    const prKrw = w.type==='us' && w.currentPrice>0 ? Math.round(w.currentPrice*usdKrw) : Math.round(w.currentPrice||0);
    const prStr = prKrw>0 ? `â‚©${prKrw.toLocaleString()}` : 'â€”';
    const tgtStr = w.target>0 ? `â‚©${Math.round(w.target).toLocaleString()}` : 'â€”';
    const tgtPct = w.target>0 && prKrw>0 ? ((w.target-prKrw)/prKrw*100).toFixed(1) : null;
    const tgtDisp = tgtPct!==null ? `${tgtStr} <span style="font-size:11px;color:${tgtPct>=0?'#ef4444':'#1d4ed8'}">(${tgtPct>=0?'+':''}${tgtPct}%)</span>` : tgtStr;
    return `<tr>
      <td><div class="stock-info">
        <div class="stock-badge" style="background:var(--g4)">${w.name[0]}</div>
        <div><div class="stock-name">${w.name}</div><div class="stock-ticker">${w.ticker}</div></div>
      </div></td>
      <td><span class="badge-type ${badge}">${bTxt}</span></td>
      <td class="text-mono">${prStr}</td>
      <td class="text-mono">${tgtDisp}</td>
      <td style="font-size:12px;color:var(--g6);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${w.memo||'â€”'}</td>
      <td><div class="row-actions" style="opacity:1">
        <button class="btn-row btn-edit" onclick="openWatchModal('${w.id}')">ìˆ˜ì •</button>
      </div></td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê±°ë˜ ë‚´ì—­
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let txList = JSON.parse(localStorage.getItem('wb_txlist') || '[]');
function saveTxList(){ localStorage.setItem('wb_txlist', JSON.stringify(txList)); }

function openTxModal(){
  document.getElementById('tf-date').value = new Date().toISOString().split('T')[0];
  ['tf-name','tf-ticker','tf-qty','tf-price','tf-memo'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('tf-type').value='buy';
  document.getElementById('tx-modal-overlay').classList.add('open');
}
function closeTxModal(){ document.getElementById('tx-modal-overlay').classList.remove('open'); }
document.getElementById('tx-modal-overlay').addEventListener('click', e=>{
  if(e.target===document.getElementById('tx-modal-overlay')) closeTxModal();
});

function saveTxItem(){
  const type = document.getElementById('tf-type').value;
  const date = document.getElementById('tf-date').value;
  const name = document.getElementById('tf-name').value.trim();
  const ticker = document.getElementById('tf-ticker').value.trim().toUpperCase();
  const qty = parseFloat(document.getElementById('tf-qty').value)||0;
  const price = parseFloat(document.getElementById('tf-price').value)||0;
  const memo = document.getElementById('tf-memo').value.trim();
  if(!date||!price){ showToast('âš ï¸','ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const total = (type==='deposit'||type==='withdraw') ? price : qty*price;
  const item = { id:String(Date.now()), type, date, name, ticker, qty, price, total, memo };
  txList.unshift(item);
  saveTxList();
  closeTxModal();
  renderTxList();
  showToast('âœ…','ê±°ë˜ ë‚´ì—­ ì¶”ê°€ë¨');
}

function deleteTx(id){
  showConfirm('ì´ ê±°ë˜ ë‚´ì—­ì„ ì‚­ì œí• ê¹Œìš”?', ()=>{
    txList = txList.filter(t=>t.id!==id);
    saveTxList();
    renderTxList();
    showToast('ğŸ—‘ï¸','ì‚­ì œë¨');
  });
}

function renderTxList(){
  const el = document.getElementById('tx-list');
  if(!txList.length){
    el.innerHTML='<div style="text-align:center;color:var(--g4);padding:24px;font-size:13px">ê±°ë˜ ë‚´ì—­ì´ ì—†ì–´ìš”<br><span style="font-size:11px">ï¼‹ ê±°ë˜ ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ë“±ë¡í•˜ì„¸ìš”</span></div>';
    return;
  }
  const icons = {buy:'ğŸ“¥',sell:'ğŸ“¤',deposit:'ğŸ’µ',withdraw:'ğŸ’¸'};
  const labels = {buy:'ë§¤ìˆ˜',sell:'ë§¤ë„',deposit:'ì…ê¸ˆ',withdraw:'ì¶œê¸ˆ'};
  el.innerHTML = txList.slice(0,20).map(t=>{
    const isBuy = t.type==='buy'||t.type==='deposit';
    const sign = isBuy?'-':'+';
    const cls = isBuy?'text-down':'text-up';
    const dateStr = t.date.replace(/-/g,'.');
    const nameStr = t.name ? `${t.name} ${labels[t.type]}` : labels[t.type];
    const subStr = t.ticker ? `${dateStr} Â· ${t.ticker}` : dateStr;
    const qtyStr = t.qty>0 ? `${t.qty}ì£¼ Ã— â‚©${Math.round(t.price).toLocaleString()}` : `â‚©${Math.round(t.price).toLocaleString()}`;
    return `<div class="tx-item">
      <div class="tx-left">
        <div class="tx-icon ${t.type==='buy'?'buy':t.type==='sell'?'sell':'deposit'}">${icons[t.type]}</div>
        <div><div class="tx-name">${nameStr}</div><div class="tx-date">${subStr}</div></div>
      </div>
      <div style="text-align:right">
        <div class="tx-price ${cls}">${sign}â‚©${Math.round(t.total).toLocaleString()}</div>
        <div class="tx-qty" style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
          ${qtyStr}
          <button onclick="deleteTx('${t.id}')" style="background:none;border:none;cursor:pointer;color:var(--g4);font-size:12px;padding:0" title="ì‚­ì œ">âœ•</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë„¤ë¹„ê²Œì´ì…˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navTo(section){
  // ëª¨ë“  nav active í•´ì œ
  document.querySelectorAll('.nav-item[id^="nav-"]').forEach(el=>el.classList.remove('active'));
  const navEl = document.getElementById('nav-'+section);
  if(navEl) navEl.classList.add('active');

  // íŠ¹ìˆ˜ íŒ¨ë„ (í¬íŠ¸í´ë¦¬ì˜¤, ìˆ˜ìµë¶„ì„)
  if(section==='portfolio' || section==='analysis'){
    showInfoPanel(section);
    return;
  }

  // íƒ­ ì „í™˜
  if(section==='watchlist') switchHoldingsTab('watchlist');
  if(section==='holdings')  switchHoldingsTab('holdings');

  // ìŠ¤í¬ë¡¤
  const target = {
    dashboard: 'section-dashboard',
    holdings:  'section-holdings',
    watchlist: 'section-holdings',
    tx:        'section-tx',
  }[section];
  if(target){
    const el = document.getElementById(target);
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  }
}

function switchHoldingsTab(tab){
  const isHoldings = tab==='holdings';
  document.getElementById('panel-holdings').style.display = isHoldings ? '' : 'none';
  document.getElementById('panel-watchlist').style.display = isHoldings ? 'none' : '';
  document.getElementById('htab-holdings').style.borderBottomColor = isHoldings ? 'var(--b6)' : 'transparent';
  document.getElementById('htab-holdings').style.color = isHoldings ? 'var(--b6)' : 'var(--g4)';
  document.getElementById('htab-watchlist').style.borderBottomColor = isHoldings ? 'transparent' : 'var(--b6)';
  document.getElementById('htab-watchlist').style.color = isHoldings ? 'var(--g4)' : 'var(--b6)';
  document.getElementById('holdings-action-btn').innerHTML = isHoldings
    ? '<button class="btn-primary" onclick="openModal()" style="font-size:11px;padding:6px 14px">ï¼‹ ì¢…ëª© ì¶”ê°€</button>'
    : '<button class="btn-primary" onclick="openWatchModal()" style="font-size:11px;padding:6px 14px">ï¼‹ ì¶”ê°€</button>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í¬íŠ¸í´ë¦¬ì˜¤ / ìˆ˜ìµë¶„ì„ ìš”ì•½ íŒ¨ë„
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showInfoPanel(type){
  const overlay = document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(13,27,62,.5);backdrop-filter:blur(4px);z-index:300;display:flex;align-items:center;justify-content:center';
  overlay.onclick = e=>{ if(e.target===overlay) document.body.removeChild(overlay); };

  const box = document.createElement('div');
  box.style.cssText='background:#fff;border-radius:20px;width:680px;max-width:95vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(13,27,62,.25)';

  if(type==='portfolio'){
    const kr = portfolio.filter(p=>p.type==='kr');
    const us = portfolio.filter(p=>p.type==='us');
    const cr = portfolio.filter(p=>p.type==='crypto');
    const krT = kr.reduce((s,p)=>s+p.qty*p.currentPrice,0);
    const usT = us.reduce((s,p)=>s+p.qty*p.currentPrice*usdKrw,0);
    const crT = cr.reduce((s,p)=>s+p.qty*p.currentPrice,0);
    const tot = krT+usT+crT;
    const krC = kr.reduce((s,p)=>s+p.qty*p.avgBuy,0);
    const usC = us.reduce((s,p)=>s+p.qty*p.avgBuy,0);
    const crC = cr.reduce((s,p)=>s+p.qty*p.avgBuy,0);
    const totC = krC+usC+crC;
    const totPct = totC ? ((tot-totC)/totC*100).toFixed(2) : 0;

    box.innerHTML = `
      <div style="padding:24px 28px;border-bottom:1px solid var(--g1);display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:18px;font-weight:700">ğŸ’¼ í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½</div>
        <button onclick="this.closest('[style*=fixed]').remove()" style="background:var(--g1);border:none;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:16px">âœ•</button>
      </div>
      <div style="padding:24px 28px">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px">
          ${[
            ['ì´ í‰ê°€ê¸ˆì•¡','ğŸ’°',`â‚©${Math.round(tot).toLocaleString()}`,`${totPct>=0?'+':''}${totPct}%`,totPct>=0],
            ['êµ­ë‚´ ì£¼ì‹','ğŸ‡°ğŸ‡·',`â‚©${Math.round(krT).toLocaleString()}`,tot?`${(krT/tot*100).toFixed(1)}%`:'-',true],
            ['í•´ì™¸ ì£¼ì‹','ğŸŒ',`â‚©${Math.round(usT).toLocaleString()}`,tot?`${(usT/tot*100).toFixed(1)}%`:'-',true],
            ['ì•”í˜¸í™”í','â‚¿',`â‚©${Math.round(crT).toLocaleString()}`,tot?`${(crT/tot*100).toFixed(1)}%`:'-',true],
            ['ì´ ë§¤ì…ê¸ˆì•¡','ğŸ’³',`â‚©${Math.round(totC).toLocaleString()}`,'ê¸°ì¤€ê¸ˆì•¡',true],
            ['í‰ê°€ì†ìµ','ğŸ“Š',`${tot-totC>=0?'+':''}â‚©${Math.round(tot-totC).toLocaleString()}`,`${totPct>=0?'+':''}${totPct}%`,tot-totC>=0],
          ].map(([label,icon,val,sub,isUp])=>`
            <div style="background:var(--g0);border-radius:12px;padding:16px">
              <div style="font-size:11px;color:var(--g4);margin-bottom:6px">${icon} ${label}</div>
              <div style="font-size:16px;font-weight:700;font-family:'DM Mono',monospace">${val}</div>
              <div style="font-size:12px;font-weight:600;color:${isUp&&sub.includes('%')?'#ef4444':sub.includes('%')&&!isUp?'#1d4ed8':'var(--g4)'};margin-top:4px">${sub}</div>
            </div>
          `).join('')}
        </div>
        <div style="font-size:14px;font-weight:700;margin-bottom:12px">ì¢…ëª©ë³„ ë¹„ì¤‘</div>
        ${portfolio.map(p=>{
          const evalKrw = p.type==='us' ? p.qty*p.currentPrice*usdKrw : p.qty*p.currentPrice;
          const pct = tot ? (evalKrw/tot*100).toFixed(1) : 0;
          const cost = p.qty*p.avgBuy;
          const gain = evalKrw-cost;
          const gainPct = cost ? (gain/cost*100).toFixed(2) : 0;
          return `<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--g1)">
            <div style="width:36px;height:36px;border-radius:10px;background:${p.color};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:13px;flex-shrink:0">${p.name[0]}</div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600">${p.name}</div><div style="font-size:11px;color:var(--g4)">${p.ticker}</div></div>
            <div style="text-align:right">
              <div style="font-size:13px;font-weight:600;font-family:'DM Mono',monospace">â‚©${Math.round(evalKrw).toLocaleString()}</div>
              <div style="font-size:11px;color:${gainPct>=0?'#ef4444':'#1d4ed8'};font-weight:600">${gainPct>=0?'â–²':'â–¼'} ${Math.abs(gainPct)}%</div>
            </div>
            <div style="width:48px;text-align:right;font-size:12px;color:var(--g4)">${pct}%</div>
          </div>`;
        }).join('')}
      </div>`;
  } else {
    // ìˆ˜ìµ ë¶„ì„
    const allItems = portfolio.filter(p=>p.currentPrice>0);
    const sorted = [...allItems].sort((a,b)=>{
      const ga = (a.type==='us'?a.qty*a.currentPrice*usdKrw:a.qty*a.currentPrice) - a.qty*a.avgBuy;
      const gb = (b.type==='us'?b.qty*b.currentPrice*usdKrw:b.qty*b.currentPrice) - b.qty*b.avgBuy;
      return gb-ga;
    });
    box.innerHTML = `
      <div style="padding:24px 28px;border-bottom:1px solid var(--g1);display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:18px;font-weight:700">ğŸ“Š ìˆ˜ìµ ë¶„ì„</div>
        <button onclick="this.closest('[style*=fixed]').remove()" style="background:var(--g1);border:none;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:16px">âœ•</button>
      </div>
      <div style="padding:24px 28px">
        <div style="font-size:14px;font-weight:700;margin-bottom:12px">ìˆ˜ìµë¥  ìˆœìœ„</div>
        ${sorted.map((p,i)=>{
          const evalKrw = p.type==='us' ? p.qty*p.currentPrice*usdKrw : p.qty*p.currentPrice;
          const cost = p.qty*p.avgBuy;
          const gain = evalKrw-cost;
          const gainPct = cost ? (gain/cost*100).toFixed(2) : 0;
          const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
          return `<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--g1)">
            <div style="font-size:20px;width:28px;text-align:center">${medals[i]||`${i+1}`}</div>
            <div style="width:34px;height:34px;border-radius:10px;background:${p.color};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:13px;flex-shrink:0">${p.name[0]}</div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600">${p.name}</div><div style="font-size:11px;color:var(--g4)">${p.ticker}</div></div>
            <div style="text-align:right">
              <div style="font-size:14px;font-weight:700;color:${gainPct>=0?'#ef4444':'#1d4ed8'}">${gainPct>=0?'+':''}${gainPct}%</div>
              <div style="font-size:11px;color:var(--g4)">${gain>=0?'+':''}â‚©${Math.round(gain).toLocaleString()}</div>
            </div>
          </div>`;
        }).join('')}
        ${!sorted.length?'<div style="text-align:center;padding:32px;color:var(--g4)">ì‹œì„¸ ë°ì´í„°ê°€ ì—†ì–´ìš”<br>ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”</div>':''}
      </div>`;
  }

  overlay.appendChild(box);
  document.body.appendChild(overlay);
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì‹œì¥ ì§€í‘œ (KOSPI, NASDAQ, í™˜ìœ¨, ê¸ˆ/ì€)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MARKET_SYMBOLS = [
  {id:'KS11',   sym:'^KS11',    label:'KOSPI',   elP:'mkt-KS11',   elC:'mkt-KS11-c',   fmt:'num'},
  {id:'IXIC',   sym:'^IXIC',    label:'NASDAQ',  elP:'mkt-IXIC',   elC:'mkt-IXIC-c',   fmt:'num'},
  {id:'DJI',    sym:'^DJI',     label:'DOW',     elP:'mkt-DJI',    elC:'mkt-DJI-c',    fmt:'num'},
  {id:'SP500',  sym:'^GSPC',    label:'S&P500',  elP:'mkt-SP500',  elC:'mkt-SP500-c',  fmt:'num'},
  {id:'USDKRW', sym:'USDKRW=X', label:'USD/KRW', elP:'mkt-USDKRW', elC:'mkt-USDKRW-c', fmt:'fx'},
  {id:'GOLD',   sym:'GC=F',     label:'ê¸ˆ',      elP:'mkt-GOLD',   elC:'mkt-GOLD-c',   fmt:'usd'},
  {id:'SILVER', sym:'SI=F',     label:'ì€',      elP:'mkt-SILVER', elC:'mkt-SILVER-c', fmt:'usd'},
];

async function fetchMarketData(){
  await Promise.all(MARKET_SYMBOLS.map(async m=>{
    try{
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), 8000);
      const r = await fetch(`${PROXY_URL}/?symbol=${encodeURIComponent(m.sym)}`, {signal:ctrl.signal});
      clearTimeout(timer);
      if(!r.ok) return;
      const d = await r.json();
      if(!d.price) return;
      const price = d.price;
      const prev = d.prevClose || price;
      const chg = price - prev;
      const pct = prev ? (chg/prev*100) : 0;
      const isUp = chg >= 0;

      // ê°€ê²© í¬ë§·
      let priceStr;
      if(m.fmt==='fx') priceStr = price.toLocaleString('ko-KR',{maximumFractionDigits:2})+'ì›';
      else if(m.fmt==='usd'){
        // ê¸ˆ/ì€: USD â†’ KRW í™˜ì‚° (oz ê¸°ì¤€)
        const krwPrice = Math.round(price * usdKrw);
        priceStr = 'â‚©'+krwPrice.toLocaleString('ko-KR');
      }
      else priceStr = price.toLocaleString('ko-KR',{maximumFractionDigits:2});

      const elP = document.getElementById(m.elP);
      const elC = document.getElementById(m.elC);
      if(elP) elP.textContent = priceStr;
      if(elC){
        elC.textContent = `${isUp?'â–²':'â–¼'} ${Math.abs(pct).toFixed(2)}%`;
        elC.className = `market-chg ${isUp?'up':'down'}`;
      }
    }catch{}
  }));
}

// prevClose ë°˜í™˜í•˜ë„ë¡ Workerë„ ì—…ë°ì´íŠ¸ í•„ìš”í•˜ì§€ë§Œ ì¼ë‹¨ ì°¨íŠ¸ë§Œ
async function showMarketChart(symbolEncoded, label, color){
  // TradingView ìœ„ì ¯ìœ¼ë¡œ ì°¨íŠ¸ í‘œì‹œ
  const existing = document.getElementById('market-chart-modal');
  if(existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'market-chart-modal';
  overlay.className = 'chart-modal-overlay';
  overlay.onclick = e=>{ if(e.target===overlay) overlay.remove(); };

  const tvSymbolMap = {
    'KS11':    'KRX:KOSPI',
    'IXIC':    'NASDAQ:NDX',
    'DJI':     'TVC:DJI',
    'S%26P500':'TVC:SPX',
    'USDKRW':  'FX_IDC:USDKRW',
    'GC%3DF':  'TVC:GOLD',
    'SI%3DF':  'TVC:SILVER',
  };
  const tvSym = tvSymbolMap[symbolEncoded] || symbolEncoded;

  overlay.innerHTML = `
    <div class="chart-modal">
      <div class="chart-modal-header">
        <div style="font-size:16px;font-weight:700">ğŸ“ˆ ${label}</div>
        <button onclick="document.getElementById('market-chart-modal').remove()"
          style="background:var(--g1);border:none;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:16px">âœ•</button>
      </div>
      <div style="height:420px">
        <iframe
          src="https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent(tvSym)}&interval=D&theme=light&style=1&locale=kr&hide_top_toolbar=0&hide_legend=0&saveimage=0&toolbarbg=f4f7f9&studies=[]&hideideas=1"
          width="100%" height="100%" frameborder="0" allowtransparency="true" scrolling="no">
        </iframe>
      </div>
    </div>`;

  document.body.appendChild(overlay);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì „ì²´ ìƒˆë¡œê³ ì¹¨
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchLive(){
  document.getElementById('api-updated').textContent = 'ì—…ë°ì´íŠ¸ ì¤‘...';
  await Promise.all([fetchFX(), fetchCrypto(), fetchAllStockPrices(), fetchMarketData()]);
  saveLocal();
  render();
  const n=new Date();
  document.getElementById('api-updated').textContent =
    `ì—…ë°ì´íŠ¸: ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
}

// ì´ˆê¸° ë¡œë“œ â€” Gistì—ì„œ ë°ì´í„° ë¨¼ì € ë¶ˆëŸ¬ì˜¨ í›„ ì‹œì„¸ ì—…ë°ì´íŠ¸
(async ()=>{
  await loadFromGist();
  await fetchLive();
  renderTxList();
  renderWatchlist();
  fetchWatchlistPrices();
  setInterval(fetchLive, 60000);
  setInterval(fetchWatchlistPrices, 60000);
})();
</script>
</body>
</html>
